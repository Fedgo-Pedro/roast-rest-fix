<Project Sdk="Microsoft.NET.Sdk.Web">

	<PropertyGroup>
		<TargetFramework>net8.0</TargetFramework>
		<Nullable>enable</Nullable>
		<ImplicitUsings>enable</ImplicitUsings>
		<RootNamespace>Roast___Rest</RootNamespace>
	</PropertyGroup>

	<ItemGroup>
		<Content Include="Models\Order.cs" />
		<Content Include="Models\UserSession.cs" />
		<Content Include="Pages\About.cshtml.cs" />
		<Content Include="Pages\Booking.cshtml.cs" />
		<Content Include="Pages\BookingSuccess.cshtml.cs" />
		<Content Include="Pages\Error.cshtml.cs" />
		<Content Include="Pages\Index.cshtml.cs" />
		<Content Include="Pages\Menu.cshtml.cs" />
		<Content Include="Pages\Privacy.cshtml.cs" />
	</ItemGroup>

	<ItemGroup>
		<None Include="wwwroot\Капучино.png" />
		<None Include="wwwroot\Классический эспрессо.png" />
		<None Include="wwwroot\Матча латте.png" />
		<None Include="wwwroot\Раф кофе.png" />
	</ItemGroup>

	<ItemGroup>
		<PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0">
		  <PrivateAssets>all</PrivateAssets>
		  <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
		</PackageReference>
		<PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="8.0.0" />
		<PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0">
		  <PrivateAssets>all</PrivateAssets>
		  <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
		</PackageReference>
		<PackageReference Include="Newtonsoft.Json" Version="13.0.1" />
		<PackageReference Include="SixLabors.ImageSharp" Version="3.1.12" />
		<PackageReference Include="System.Drawing.Common" Version="8.0.0" />
	</ItemGroup>

</Project>

=== AdminMenu.cshtml.cs ===
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.EntityFrameworkCore;
using Roast___Rest.Data;
using Roast___Rest.Models.Database;
using System.Text;
using System.Text.RegularExpressions;

namespace Roast___Rest.Pages.Admin
{
    [Authorize(Roles = "Admin")]
    public class AdminMenuModel : PageModel
    {
        private readonly AppDbContext _context;
        private readonly IWebHostEnvironment _environment;
        private readonly ILogger<AdminMenuModel> _logger;

        public AdminMenuModel(
            AppDbContext context,
            IWebHostEnvironment environment,
            ILogger<AdminMenuModel> logger)
        {
            _context = context;
            _environment = environment;
            _logger = logger;
        }

        public List<MenuItem> MenuItems { get; set; } = new();

        [BindProperty]
        public MenuItem NewItem { get; set; } = new();

        [BindProperty]
        public MenuItem EditItem { get; set; } = new();

        [TempData]
        public string? Message { get; set; }

        [TempData]
        public string? ErrorMessage { get; set; }

        public async Task OnGetAsync()
        {
            MenuItems = await _context.MenuItems
                .OrderBy(m => m.Category)
                .ThenBy(m => m.Name)
                .ToListAsync();
        }

        public async Task<IActionResult> OnPostAddAsync()
        {
            if (!User.IsInRole("Admin"))
            {
                return Forbid();
            }

            try
            {
                _logger.LogInformation("=== НАЧАЛО ДОБАВЛЕНИЯ ===");

                var form = await Request.ReadFormAsync();

                // Проверяем обязательные поля
                if (string.IsNullOrEmpty(form["Name"]))
                {
                    return new JsonResult(new { success = false, message = "Название обязательно" });
                }

                if (string.IsNullOrEmpty(form["Category"]))
                {
                    return new JsonResult(new { success = false, message = "Категория обязательна" });
                }

                if (!decimal.TryParse(form["Price"].ToString(), out decimal price))
                {
                    return new JsonResult(new { success = false, message = "Цена должна быть числом" });
                }

                var newItem = new MenuItem
                {
                    Name = form["Name"].ToString().Trim(),
                    Category = form["Category"].ToString().ToLower().Trim(),
                    Description = form["Description"].ToString().Trim(),
                    Price = price,
                    IsPopular = form.ContainsKey("IsPopular") && form["IsPopular"] == "true",
                    IsNew = form.ContainsKey("IsNew") && form["IsNew"] == "true",
                    IsAvailable = true,
                    Temperature = form["Temperature"].ToString().Trim(),
                    Volume = form["Volume"].ToString().Trim(),
                    Weight = form["Weight"].ToString().Trim(),
                    PrepTime = !string.IsNullOrEmpty(form["PrepTime"]) ? int.Parse(form["PrepTime"].ToString()) : (int?)null,
                    ContainsNuts = form.ContainsKey("ContainsNuts") && form["ContainsNuts"] == "true",
                    CreatedAt = DateTime.UtcNow
                };

                // Проверка на дубликаты
                var existing = await _context.MenuItems
                    .FirstOrDefaultAsync(m => m.Name == newItem.Name && m.Category == newItem.Category);

                if (existing != null)
                {
                    return new JsonResult(new { success = false, message = "Элемент с таким названием уже существует в этой категории" });
                }

                // Обработка изображения
                if (Request.Form.Files.Count > 0)
                {
                    var imageFile = Request.Form.Files[0];
                    if (imageFile != null && imageFile.Length > 0)
                    {
                        _logger.LogInformation("Загружается файл: {FileName}, размер: {Size}", imageFile.FileName, imageFile.Length);

                        string fileName = await SaveImageFile(imageFile, newItem.Category, newItem.Name);
                        if (!string.IsNullOrEmpty(fileName))
                        {
                            newItem.ImageName = fileName;
                            _logger.LogInformation("Изображение сохранено с именем: {FileName}", fileName);
                        }
                        else
                        {
                            _logger.LogWarning("Не удалось сохранить изображение");
                        }
                    }
                }

                _context.MenuItems.Add(newItem);
                await _context.SaveChangesAsync();

                _logger.LogInformation("Элемент успешно добавлен с ID: {Id}", newItem.Id);

                return new JsonResult(new { success = true, message = "Элемент успешно добавлен!" });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Ошибка при добавлении элемента");
                return new JsonResult(new { success = false, message = $"Ошибка: {ex.Message}" });
            }
        }

        public async Task<IActionResult> OnPostEditAsync(int id)
        {
            if (!User.IsInRole("Admin"))
            {
                return Forbid();
            }

            try
            {
                _logger.LogInformation("=== НАЧАЛО РЕДАКТИРОВАНИЯ ID: {Id} ===", id);

                var form = await Request.ReadFormAsync();

                // Логируем все ключи формы для отладки
                _logger.LogInformation("Ключи формы: {Keys}", string.Join(", ", form.Keys));
                _logger.LogInformation("Количество файлов: {FileCount}", Request.Form.Files.Count);

                if (Request.Form.Files.Count > 0)
                {
                    var file = Request.Form.Files[0];
                    _logger.LogInformation("Файл: {FileName}, размер: {Size}, тип: {ContentType}",
                        file.FileName, file.Length, file.ContentType);
                }

                // Проверяем обязательные поля
                if (string.IsNullOrEmpty(form["Name"]))
                {
                    _logger.LogWarning("Ошибка: название не заполнено");
                    return new JsonResult(new { success = false, message = "Название обязательно" });
                }

                if (!decimal.TryParse(form["Price"].ToString(), out decimal price))
                {
                    _logger.LogWarning("Ошибка: цена должна быть числом, получено: {Price}", form["Price"]);
                    return new JsonResult(new { success = false, message = "Цена должна быть числом" });
                }

                string imageAction = form["ImageAction"].ToString();
                _logger.LogInformation("ImageAction: {ImageAction}", imageAction);

                var item = await _context.MenuItems.FindAsync(id);
                if (item == null)
                {
                    _logger.LogWarning("Элемент с ID {Id} не найден", id);
                    return new JsonResult(new { success = false, message = "Элемент не найден" });
                }

                _logger.LogInformation("Текущее изображение элемента: {ImageName}", item.ImageName ?? "нет");

                // Проверка на дубликаты (исключая текущий элемент)
                var existing = await _context.MenuItems
                    .FirstOrDefaultAsync(m => m.Name == form["Name"].ToString() &&
                                              m.Category == form["Category"].ToString() &&
                                              m.Id != id);

                if (existing != null)
                {
                    _logger.LogWarning("Найден дубликат с ID {ExistingId}", existing.Id);
                    return new JsonResult(new { success = false, message = "Элемент с таким названием уже существует в этой категории" });
                }

                // Обработка изображения
                if (imageAction == "delete")
                {
                    _logger.LogInformation("Удаление изображения для элемента {Id}", id);
                    await DeleteImageFile(item.ImageName, item.Category);
                    item.ImageName = null;
                    _logger.LogInformation("Изображение удалено");
                }
                else if (imageAction == "change")
                {
                    _logger.LogInformation("Замена изображения для элемента {Id}", id);

                    if (Request.Form.Files.Count > 0)
                    {
                        var uploadedFile = Request.Form.Files[0];
                        if (uploadedFile != null && uploadedFile.Length > 0)
                        {
                            _logger.LogInformation("Загружен файл: {FileName}, размер: {Size}",
                                uploadedFile.FileName, uploadedFile.Length);

                            // Удаляем старое изображение
                            if (!string.IsNullOrEmpty(item.ImageName))
                            {
                                await DeleteImageFile(item.ImageName, item.Category);
                                _logger.LogInformation("Старое изображение {OldImage} удалено", item.ImageName);
                            }

                            // Сохраняем новое
                            string fileName = await SaveImageFile(uploadedFile, form["Category"].ToString(), form["Name"].ToString());
                            if (!string.IsNullOrEmpty(fileName))
                            {
                                item.ImageName = fileName;
                                _logger.LogInformation("Новое изображение сохранено: {FileName}", fileName);
                            }
                            else
                            {
                                _logger.LogError("Не удалось сохранить новое изображение");
                                return new JsonResult(new { success = false, message = "Ошибка при сохранении изображения" });
                            }
                        }
                        else
                        {
                            _logger.LogWarning("Файл загружен, но пустой");
                        }
                    }
                    else
                    {
                        _logger.LogWarning("Выбрано действие 'change', но файл не загружен");
                    }
                }
                else
                {
                    _logger.LogInformation("Изображение не изменяется (keep)");
                }

                // Обновляем остальные поля
                string oldName = item.Name;
                string newName = form["Name"].ToString().Trim();

                item.Name = newName;
                item.Category = form["Category"].ToString().ToLower().Trim();
                item.Description = form["Description"].ToString().Trim();
                item.Price = price;
                item.IsPopular = form.ContainsKey("IsPopular") && form["IsPopular"] == "true";
                item.IsNew = form.ContainsKey("IsNew") && form["IsNew"] == "true";
                item.IsAvailable = form.ContainsKey("IsAvailable") && form["IsAvailable"] == "true";
                item.Temperature = form["Temperature"].ToString().Trim();
                item.Volume = form["Volume"].ToString().Trim();
                item.Weight = form["Weight"].ToString().Trim();
                item.PrepTime = !string.IsNullOrEmpty(form["PrepTime"]) ? int.Parse(form["PrepTime"].ToString()) : (int?)null;
                item.ContainsNuts = form.ContainsKey("ContainsNuts") && form["ContainsNuts"] == "true";
                item.UpdatedAt = DateTime.UtcNow;

                _logger.LogInformation("Обновление полей: Name: {OldName} -> {NewName}, Category: {Category}, Price: {Price}",
                    oldName, newName, item.Category, price);

                await _context.SaveChangesAsync();

                string message = imageAction == "delete" ? "Элемент обновлен, изображение удалено" :
                                (imageAction == "change" ? "Элемент обновлен с новым изображением" : "Элемент успешно обновлен");

                _logger.LogInformation("Элемент {Id} успешно обновлен. Итоговое изображение: {ImageName}",
                    id, item.ImageName ?? "нет");

                return new JsonResult(new { success = true, message = message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Ошибка при обновлении элемента");
                _logger.LogError("Message: {Message}", ex.Message);
                _logger.LogError("StackTrace: {StackTrace}", ex.StackTrace);
                return new JsonResult(new { success = false, message = $"Ошибка: {ex.Message}" });
            }
        }

        public async Task<IActionResult> OnPostDeleteAsync(int id)
        {
            if (!User.IsInRole("Admin"))
            {
                return Forbid();
            }

            try
            {
                var item = await _context.MenuItems.FindAsync(id);
                if (item != null)
                {
                    await DeleteImageFile(item.ImageName, item.Category);
                    _context.MenuItems.Remove(item);
                    await _context.SaveChangesAsync();
                }

                return new JsonResult(new { success = true });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Ошибка при удалении элемента");
                return new JsonResult(new { success = false, message = ex.Message });
            }
        }

        public async Task<IActionResult> OnPostTogglePopularAsync(int id)
        {
            if (!User.IsInRole("Admin")) return Forbid();

            var item = await _context.MenuItems.FindAsync(id);
            if (item != null)
            {
                item.IsPopular = !item.IsPopular;
                item.UpdatedAt = DateTime.UtcNow;
                await _context.SaveChangesAsync();
            }
            return new JsonResult(new { success = true });
        }

        public async Task<IActionResult> OnPostToggleNewAsync(int id)
        {
            if (!User.IsInRole("Admin")) return Forbid();

            var item = await _context.MenuItems.FindAsync(id);
            if (item != null)
            {
                item.IsNew = !item.IsNew;
                item.UpdatedAt = DateTime.UtcNow;
                await _context.SaveChangesAsync();
            }
            return new JsonResult(new { success = true });
        }

        public async Task<IActionResult> OnPostToggleAvailableAsync(int id)
        {
            if (!User.IsInRole("Admin")) return Forbid();

            var item = await _context.MenuItems.FindAsync(id);
            if (item != null)
            {
                item.IsAvailable = !item.IsAvailable;
                item.UpdatedAt = DateTime.UtcNow;
                await _context.SaveChangesAsync();
            }
            return new JsonResult(new { success = true });
        }

        private async Task<string> SaveImageFile(IFormFile uploadedFile, string category, string itemName)
        {
            try
            {
                _logger.LogInformation("=== СОХРАНЕНИЕ ФАЙЛА ===");
                _logger.LogInformation("Original FileName: {FileName}", uploadedFile.FileName);
                _logger.LogInformation("Size: {Size} байт", uploadedFile.Length);
                _logger.LogInformation("Category: {Category}", category);
                _logger.LogInformation("ItemName: {ItemName}", itemName);

                // Проверка расширения
                var allowedExtensions = new[] { ".png", ".jpg", ".jpeg", ".gif", ".bmp", ".webp" };
                var extension = Path.GetExtension(uploadedFile.FileName).ToLowerInvariant();

                if (!allowedExtensions.Contains(extension))
                {
                    _logger.LogWarning("Недопустимое расширение файла: {Extension}", extension);
                    return string.Empty;
                }

                // Проверка размера
                if (uploadedFile.Length > 5 * 1024 * 1024)
                {
                    _logger.LogWarning("Файл слишком большой: {Size} байт", uploadedFile.Length);
                    return string.Empty;
                }

                // Генерируем имя файла на основе названия элемента + timestamp
                string baseFileName = Transliterate(itemName);
                baseFileName = Regex.Replace(baseFileName, @"[^a-zA-Z0-9]", "-");
                baseFileName = Regex.Replace(baseFileName, @"-+", "-").Trim('-');

                if (string.IsNullOrEmpty(baseFileName))
                {
                    baseFileName = "image";
                }

                // Добавляем timestamp для уникальности
                string fileName = $"{baseFileName}_{DateTime.Now.Ticks}";

                string categoryFolder = GetCategoryFolder(category);
                string uploadPath = Path.Combine(_environment.WebRootPath, "images", "menu", categoryFolder);

                _logger.LogInformation("UploadPath: {UploadPath}", uploadPath);
                _logger.LogInformation("FileName будет: {FileName}.png", fileName);

                // Создаем папку, если её нет
                if (!System.IO.Directory.Exists(uploadPath))
                {
                    _logger.LogInformation("Создаем папку: {UploadPath}", uploadPath);
                    System.IO.Directory.CreateDirectory(uploadPath);
                }

                string filePath = System.IO.Path.Combine(uploadPath, fileName + ".png");
                _logger.LogInformation("Полный путь к файлу: {FilePath}", filePath);

                // Сохраняем файл
                using (var stream = new System.IO.FileStream(filePath, System.IO.FileMode.Create))
                {
                    await uploadedFile.CopyToAsync(stream);
                    await stream.FlushAsync();
                }

                // Проверяем, что файл создан
                if (System.IO.File.Exists(filePath))
                {
                    var fileInfo = new System.IO.FileInfo(filePath);
                    _logger.LogInformation("Файл успешно создан. Размер на диске: {Size} байт", fileInfo.Length);
                }
                else
                {
                    _logger.LogError("Файл НЕ БЫЛ создан!");
                    return string.Empty;
                }

                _logger.LogInformation("=== ФАЙЛ УСПЕШНО СОХРАНЕН ===");
                return fileName;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "ОШИБКА при сохранении файла");
                _logger.LogError("Message: {Message}", ex.Message);
                _logger.LogError("StackTrace: {StackTrace}", ex.StackTrace);
                return string.Empty;
            }
        }

        private async Task DeleteImageFile(string imageName, string category)
        {
            if (string.IsNullOrEmpty(imageName))
                return;

            try
            {
                string categoryFolder = GetCategoryFolder(category);

                // Ищем файл с разными расширениями
                string[] extensions = { ".png", ".jpg", ".jpeg", ".gif", ".bmp", ".webp" };

                foreach (var ext in extensions)
                {
                    string filePath = System.IO.Path.Combine(_environment.WebRootPath, "images", "menu", categoryFolder, imageName + ext);

                    if (System.IO.File.Exists(filePath))
                    {
                        System.IO.File.Delete(filePath);
                        _logger.LogInformation("Файл удален: {FilePath}", filePath);
                        break;
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Ошибка при удалении файла {ImageName}", imageName);
            }

            await Task.CompletedTask;
        }

        private string GetCategoryFolder(string category)
        {
            return category.ToLower() switch
            {
                "coffee" => "coffee",
                "tea" => "tea",
                "dessert" => "dessert",
                _ => "other"
            };
        }

        private string Transliterate(string text)
        {
            var rus = new Dictionary<char, string>
            {
                {'а', "a"}, {'б', "b"}, {'в', "v"}, {'г', "g"}, {'д', "d"},
                {'е', "e"}, {'ё', "e"}, {'ж', "zh"}, {'з', "z"}, {'и', "i"},
                {'й', "y"}, {'к', "k"}, {'л', "l"}, {'м', "m"}, {'н', "n"},
                {'о', "o"}, {'п', "p"}, {'р', "r"}, {'с', "s"}, {'т', "t"},
                {'у', "u"}, {'ф', "f"}, {'х', "kh"}, {'ц', "ts"}, {'ч', "ch"},
                {'ш', "sh"}, {'щ', "shch"}, {'ъ', ""}, {'ы', "y"}, {'ь', ""},
                {'э', "e"}, {'ю', "yu"}, {'я', "ya"},
                {'А', "A"}, {'Б', "B"}, {'В', "V"}, {'Г', "G"}, {'Д', "D"},
                {'Е', "E"}, {'Ё', "E"}, {'Ж', "Zh"}, {'З', "Z"}, {'И', "I"},
                {'Й', "Y"}, {'К', "K"}, {'Л', "L"}, {'М', "M"}, {'Н', "N"},
                {'О', "O"}, {'П', "P"}, {'Р', "R"}, {'С', "S"}, {'Т', "T"},
                {'У', "U"}, {'Ф', "F"}, {'Х', "Kh"}, {'Ц', "Ts"}, {'Ч', "Ch"},
                {'Ш', "Sh"}, {'Щ', "Shch"}, {'Ъ', ""}, {'Ы', "Y"}, {'Ь', ""},
                {'Э', "E"}, {'Ю', "Yu"}, {'Я', "Ya"}
            };

            var result = new StringBuilder();
            foreach (var ch in text)
            {
                if (rus.ContainsKey(ch))
                    result.Append(rus[ch]);
                else if (char.IsLetterOrDigit(ch) || ch == '-' || ch == '_' || ch == ' ')
                    result.Append(ch == ' ' ? '-' : ch);
                else
                    result.Append('-');
            }

            return result.ToString();
        }
    }
}

=== AdminMenu.cshtml ===
@page
@model Roast___Rest.Pages.Admin.AdminMenuModel
@{
    ViewData["Title"] = "Админ-панель - Управление меню";
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    :root {
        --primary: #D4A76A;
        --secondary: #8B4513;
        --dark: #2C1810;
        --light: #F9F5F0;
        --text-dark: #3F2723;
        --text-light: #5C4E3D;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--light);
        margin: 0;
        padding: 20px;
    }

    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .admin-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .admin-title {
        font-size: 2.5rem;
        color: var(--dark);
        margin-bottom: 10px;
    }

    .admin-subtitle {
        color: var(--text-light);
        font-size: 1.1rem;
    }

    .btn-add {
        background: var(--primary);
        color: #0A0A0A;
        border: none;
        padding: 15px 30px;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }

        .btn-add:hover {
            background: #E6B87E;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 167, 106, 0.3);
        }

    .category-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 10px 20px;
        border: 2px solid var(--primary);
        background: transparent;
        color: var(--text-dark);
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .filter-btn.active {
            background: var(--primary);
            color: #0A0A0A;
        }

        .filter-btn:hover {
            background: rgba(212, 167, 106, 0.1);
        }

    .table-wrapper {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
    }

        .admin-table th {
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(139, 69, 19, 0.1);
            vertical-align: middle;
        }

        .admin-table tr:hover {
            background: rgba(212, 167, 106, 0.05);
        }

    .table-image {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--light);
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .table-image:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .table-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .table-image i {
            font-size: 2rem;
            color: var(--text-light);
        }

    .category-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
    }

    .category-coffee {
        background: #5D4037;
        color: white;
    }

    .category-tea {
        background: #2E7D32;
        color: white;
    }

    .category-dessert {
        background: #6A1B9A;
        color: white;
    }

    .status-badges {
        display: flex;
        gap: 8px;
    }

    .badge {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

        .badge.popular {
            background: #FFD700;
            color: #000;
        }

        .badge.not-popular {
            background: #f0f0f0;
            color: #999;
        }

        .badge.new {
            background: #4ECDC4;
            color: #000;
        }

        .badge.not-new {
            background: #f0f0f0;
            color: #999;
        }

        .badge.available {
            background: #28a745;
            color: white;
        }

        .badge.not-available {
            background: #dc3545;
            color: white;
        }

        .badge:hover {
            transform: scale(1.1);
        }

        .badge.loading {
            opacity: 0.5;
            pointer-events: none;
            animation: pulse 1s infinite;
        }

    @@keyframes pulse {
        0% {
            opacity: 0.5;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.5;
        }
    }

    .specs {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .nuts-warning {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 5px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-edit, .btn-delete {
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-edit {
        background: rgba(212, 167, 106, 0.1);
        color: var(--primary);
    }

        .btn-edit:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

    .btn-delete {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

        .btn-delete:hover {
            background: #dc3545;
            color: white;
            transform: scale(1.1);
        }

    /* Модальные окна */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        overflow: auto;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: white;
        margin: 50px auto;
        padding: 30px;
        border-radius: 20px;
        max-width: 700px;
        position: relative;
        animation: slideDown 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
    }

    @@keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(139, 69, 19, 0.1);
    }

        .modal-header h2 {
            font-family: 'Playfair Display', serif;
            color: var(--dark);
            margin: 0;
        }

    .close {
        font-size: 28px;
        font-weight: bold;
        color: var(--text-light);
        cursor: pointer;
        transition: color 0.3s ease;
    }

        .close:hover {
            color: var(--primary);
        }

    /* Вкладки */
    .modal-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        border-bottom: 2px solid rgba(139, 69, 19, 0.1);
        padding-bottom: 10px;
    }

    .modal-tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        border-radius: 30px;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        color: var(--text-light);
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .modal-tab.active {
            background: var(--primary);
            color: #0A0A0A;
        }

        .modal-tab:hover:not(.active) {
            background: rgba(212, 167, 106, 0.1);
            color: var(--primary);
        }

    .tab-pane {
        display: none;
    }

        .tab-pane.active {
            display: block;
        }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-group.checkbox-group {
        display: flex;
        align-items: center;
    }

        .form-group.checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .form-group.checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid transparent;
        border-radius: 8px;
        background: var(--light);
        font-family: 'Inter', sans-serif;
        transition: all 0.3s ease;
    }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

    select.form-control {
        cursor: pointer;
    }

    /* Стили для загрузки файлов */
    .file-upload-container {
        position: relative;
        border: 2px dashed rgba(212, 167, 106, 0.3);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--light);
        margin-bottom: 15px;
    }

        .file-upload-container:hover {
            border-color: var(--primary);
            background: rgba(212, 167, 106, 0.05);
        }

        .file-upload-container.dragover {
            border-color: var(--primary);
            background: rgba(212, 167, 106, 0.1);
            transform: scale(1.02);
        }

    .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .file-upload-preview {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        color: var(--text-light);
    }

        .file-upload-preview i {
            font-size: 2.5rem;
            color: var(--primary);
        }

        .file-upload-preview span {
            font-size: 0.9rem;
        }

        .file-upload-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            object-fit: cover;
        }

    .file-name {
        margin-top: 10px;
        font-size: 0.9rem;
        color: var(--primary);
        font-weight: 500;
    }

    /* Область текущего изображения */
    .current-image-section {
        margin: 20px 0;
        padding: 20px;
        background: var(--light);
        border-radius: 10px;
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .current-image-title {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .current-image-title i {
            color: var(--primary);
        }

    .current-image-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .image-preview {
        width: 150px;
        height: 150px;
        border-radius: 10px;
        overflow: hidden;
        border: 3px solid var(--primary);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .image-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(212, 167, 106, 0.3);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .image-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .btn-delete-image {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: rgba(220, 53, 69, 0.1);
        color: var(--danger);
        border: 2px solid var(--danger);
        border-radius: 6px;
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-delete-image:hover {
            background: var(--danger);
            color: white;
        }

    .btn-view-image {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: rgba(212, 167, 106, 0.1);
        color: var(--primary);
        border: 2px solid var(--primary);
        border-radius: 6px;
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-view-image:hover {
            background: var(--primary);
            color: white;
        }

    .image-status-badge {
        display: inline-block;
        padding: 5px 12px;
        background: var(--success);
        color: white;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Прогресс-бар загрузки */
    .upload-progress {
        margin-top: 15px;
        display: none;
    }

        .upload-progress.show {
            display: block;
        }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-text {
        font-size: 0.8rem;
        color: var(--text-light);
        margin-top: 5px;
        text-align: right;
    }

    /* Модальное окно предпросмотра изображения */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 1100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        overflow: auto;
    }

    .image-modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 5px solid var(--primary);
        border-radius: 10px;
        box-shadow: 0 0 30px rgba(212, 167, 106, 0.5);
    }

    .image-modal-close {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
    }

        .image-modal-close:hover {
            color: var(--primary);
        }

    /* Радио-кнопки для выбора действия с изображением */
    .image-action-options {
        display: flex;
        gap: 15px;
        margin: 15px 0;
        padding: 15px;
        background: var(--light);
        border-radius: 10px;
    }

    .image-action-option {
        flex: 1;
        cursor: pointer;
    }

        .image-action-option input[type="radio"] {
            display: none;
        }

        .image-action-option .option-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .image-action-option input[type="radio"]:checked + .option-content {
            border-color: var(--primary);
            background: rgba(212, 167, 106, 0.05);
            box-shadow: 0 5px 15px rgba(212, 167, 106, 0.2);
        }

        .image-action-option i {
            font-size: 1.5rem;
            color: var(--primary);
        }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid rgba(139, 69, 19, 0.1);
    }

    .btn-cancel, .btn-save {
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-cancel {
        background: #f0f0f0;
        color: var(--text-dark);
    }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

    .btn-save {
        background: var(--primary);
        color: #0A0A0A;
    }

        .btn-save:hover {
            background: #E6B87E;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 167, 106, 0.3);
        }

        .btn-save:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        animation: slideIn 0.3s ease;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        border-left: 4px solid var(--primary);
        max-width: 350px;
    }

        .toast-notification.show {
            transform: translateX(0);
        }

    .toast-success {
        border-left-color: #28a745;
    }

    .toast-error {
        border-left-color: #dc3545;
    }

    .toast-warning {
        border-left-color: #ffc107;
    }

    .toast-notification i {
        font-size: 1.2rem;
    }

    .toast-success i {
        color: #28a745;
    }

    .toast-error i {
        color: #dc3545;
    }

    .toast-warning i {
        color: #ffc107;
    }

    .text-muted {
        color: #6c757d;
        font-size: 0.85rem;
        margin-top: 5px;
        display: block;
    }

    @@media (max-width: 768px) {
        .admin-table {
            font-size: 0.9rem;
        }

        .table-image {
            width: 40px;
            height: 40px;
        }

        .status-badges {
            flex-direction: column;
        }

        .badge {
            width: 30px;
            height: 30px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            margin: 20px;
            padding: 20px;
        }

        .image-action-options {
            flex-direction: column;
        }
    }
</style>

<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-crown" style="color: var(--primary);"></i>
            Админ-панель
        </h1>
        <p class="admin-subtitle">Управление меню кофейни</p>
    </div>

    <!-- Контейнер для уведомлений -->
    <div id="toastContainer"></div>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-success">@Model.Message</div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn-add" onclick="openAddModal()">
            <i class="fas fa-plus"></i>
            Добавить новый элемент
        </button>
    </div>

    <div class="category-filters">
        <button class="filter-btn active" data-filter="all">Все</button>
        <button class="filter-btn" data-filter="coffee">Кофе</button>
        <button class="filter-btn" data-filter="tea">Чай</button>
        <button class="filter-btn" data-filter="dessert">Десерты</button>
    </div>

    <!-- Таблица меню -->
    <div class="table-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Изображение</th>
                    <th>Название</th>
                    <th>Категория</th>
                    <th>Цена</th>
                    <th>Статусы</th>
                    <th>Характеристики</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="menuTableBody">
                @foreach (var item in Model.MenuItems)
                {
                    <tr class="menu-row" data-id="@item.Id" data-category="@item.Category">
                        <td>@item.Id</td>
                        <td>
                            <div class="table-image" onclick="viewImage('@item.Category', '@item.ImageName', '@item.Name')">
                                @if (!string.IsNullOrEmpty(item.ImageName))
                                {
                                    <img src="/images/menu/@item.Category/@(item.ImageName).png"
                                         alt="@item.Name"
                                         onerror="this.onerror=null; this.src='/images/placeholder.png'">
                                }
                                else
                                {
                                    <i class="fas fa-image" style="color: #ccc;"></i>
                                }
                            </div>
                        </td>
                        <td>@item.Name</td>
                        <td>
                            <span class="category-badge category-@item.Category">
                                @(item.Category == "coffee" ? "Кофе" : item.Category == "tea" ? "Чай" : "Десерт")
                            </span>
                        </td>
                        <td>@item.Price ₽</td>
                        <td>
                            <div class="status-badges">
                                @if (item.IsPopular)
                                {
                                    <span class="badge popular" onclick="togglePopular(@item.Id, this)">
                                        <i class="fas fa-star"></i>
                                    </span>
                                }
                                else
                                {
                                    <span class="badge not-popular" onclick="togglePopular(@item.Id, this)">
                                        <i class="far fa-star"></i>
                                    </span>
                                }

                                @if (item.IsNew)
                                {
                                    <span class="badge new" onclick="toggleNew(@item.Id, this)">
                                        <i class="fas fa-gem"></i>
                                    </span>
                                }
                                else
                                {
                                    <span class="badge not-new" onclick="toggleNew(@item.Id, this)">
                                        <i class="far fa-gem"></i>
                                    </span>
                                }

                                @if (item.IsAvailable)
                                {
                                    <span class="badge available" onclick="toggleAvailable(@item.Id, this)">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                }
                                else
                                {
                                    <span class="badge not-available" onclick="toggleAvailable(@item.Id, this)">
                                        <i class="fas fa-times-circle"></i>
                                    </span>
                                }
                            </div>
                        </td>
                        <td>
                            @if (item.Category == "coffee" || item.Category == "tea")
                            {
                                <div class="specs">
                                    <div>🌡️ @item.Temperature</div>
                                    <div>🥤 @item.Volume</div>
                                </div>
                            }
                            else if (item.Category == "dessert")
                            {
                                <div class="specs">
                                    <div>⚖️ @item.Weight</div>
                                    <div>⏱️ @item.PrepTime мин</div>
                                    @if (item.ContainsNuts)
                                    {
                                        <div class="nuts-warning">🥜 С орехами</div>
                                    }
                                </div>
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick='openEditModal(@Html.Raw(Json.Serialize(item)))'>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete" onclick="confirmDelete(@item.Id, '@item.Name')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно добавления -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Добавить новый элемент</h2>
            <span class="close" onclick="closeAddModal()">&times;</span>
        </div>

        <form id="addForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <div class="modal-tabs">
                <button type="button" class="modal-tab active" data-tab="add-basic">Основное</button>
                <button type="button" class="modal-tab" data-tab="add-image">Изображение</button>
                <button type="button" class="modal-tab" data-tab="add-specs">Характеристики</button>
            </div>

            <!-- Вкладка Основное -->
            <div class="tab-pane active" id="add-basic">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Название *</label>
                        <input type="text" name="Name" class="form-control" id="addName" required>
                    </div>

                    <div class="form-group">
                        <label>Категория *</label>
                        <select name="Category" class="form-control" required id="addCategory">
                            <option value="">Выберите категорию</option>
                            <option value="coffee">Кофе</option>
                            <option value="tea">Чай</option>
                            <option value="dessert">Десерт</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label>Описание</label>
                        <textarea name="Description" class="form-control" id="addDescription" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Цена *</label>
                        <input type="number" name="Price" class="form-control" id="addPrice" step="1" min="1" required>
                    </div>
                </div>
            </div>

            <!-- Вкладка Изображение -->
            <div class="tab-pane" id="add-image">
                <div class="form-group full-width">
                    <label>Изображение</label>
                    <div class="file-upload-container" id="addDropZone">
                        <input type="file" name="ImageFile" id="addImageFile" accept="image/*" class="file-input">
                        <div class="file-upload-preview" id="addImagePreview">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Выберите файл или перетащите сюда</span>
                        </div>
                        <div class="file-name" id="addFileName"></div>
                    </div>

                    <div class="upload-progress" id="addUploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="addProgressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="addProgressText">0%</div>
                    </div>

                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        • Форматы: PNG, JPG, JPEG, GIF, WEBP<br>
                        • Макс. размер: 5MB<br>
                        • Рекомендуемый размер: 800x800px
                    </small>
                </div>

                <div class="form-group checkbox-group mt-3">
                    <label>
                        <input type="checkbox" name="IsPopular" id="addIsPopular" value="true">
                        Популярное
                    </label>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="IsNew" id="addIsNew" value="true">
                        Новинка
                    </label>
                </div>
            </div>

            <!-- Вкладка Характеристики -->
            <div class="tab-pane" id="add-specs">
                <div class="coffee-fields" style="display: none;">
                    <h4 class="mb-3">Характеристики напитка</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Температура</label>
                            <input type="text" name="Temperature" class="form-control" id="addTemperature" placeholder="85°C">
                        </div>

                        <div class="form-group">
                            <label>Объем</label>
                            <input type="text" name="Volume" class="form-control" id="addVolume" placeholder="200 мл">
                        </div>
                    </div>
                </div>

                <div class="dessert-fields" style="display: none;">
                    <h4 class="mb-3">Характеристики десерта</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Вес</label>
                            <input type="text" name="Weight" class="form-control" id="addWeight" placeholder="150 г">
                        </div>

                        <div class="form-group">
                            <label>Время приготовления (мин)</label>
                            <input type="number" name="PrepTime" class="form-control" id="addPrepTime" min="1">
                        </div>
                    </div>

                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" name="ContainsNuts" id="addContainsNuts" value="true">
                            Содержит орехи
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeAddModal()">Отмена</button>
                <button type="submit" class="btn-save" id="addSubmitBtn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно редактирования -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Редактировать элемент</h2>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>

        <form id="editForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" id="editId">

            <div class="modal-tabs">
                <button type="button" class="modal-tab active" data-tab="edit-basic">Основное</button>
                <button type="button" class="modal-tab" data-tab="edit-image">Изображение</button>
                <button type="button" class="modal-tab" data-tab="edit-specs">Характеристики</button>
            </div>

            <!-- Вкладка Основное -->
            <div class="tab-pane active" id="edit-basic">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Название *</label>
                        <input type="text" name="Name" id="editName" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>Категория *</label>
                        <select name="Category" id="editCategory" class="form-control" required>
                            <option value="coffee">Кофе</option>
                            <option value="tea">Чай</option>
                            <option value="dessert">Десерт</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label>Описание</label>
                        <textarea name="Description" id="editDescription" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Цена *</label>
                        <input type="number" name="Price" id="editPrice" class="form-control" step="1" min="1" required>
                    </div>
                </div>
            </div>

            <!-- Вкладка Изображение -->
            <div class="tab-pane" id="edit-image">
                <!-- Выбор действия с изображением -->
                <div class="image-action-options">
                    <label class="image-action-option">
                        <input type="radio" name="imageAction" value="keep" checked>
                        <span class="option-content">
                            <i class="fas fa-save"></i>
                            <span>Оставить текущее</span>
                        </span>
                    </label>
                    <label class="image-action-option">
                        <input type="radio" name="imageAction" value="change">
                        <span class="option-content">
                            <i class="fas fa-upload"></i>
                            <span>Загрузить новое</span>
                        </span>
                    </label>
                    <label class="image-action-option">
                        <input type="radio" name="imageAction" value="delete">
                        <span class="option-content">
                            <i class="fas fa-trash"></i>
                            <span>Удалить изображение</span>
                        </span>
                    </label>
                </div>

                <!-- Текущее изображение -->
                <div class="current-image-section" id="currentImageSection">
                    <div class="current-image-title">
                        <i class="fas fa-image"></i>
                        Текущее изображение
                        <span class="image-status-badge" id="imageStatusBadge">Есть</span>
                    </div>
                    <div class="current-image-container">
                        <div class="image-preview" onclick="viewFullImage()">
                            <img id="currentImage" src="" alt="Текущее изображение">
                        </div>
                        <input type="hidden" name="CurrentImageName" id="currentImageName">

                        <div class="image-actions">
                            <button type="button" class="btn-view-image" onclick="viewFullImage()">
                                <i class="fas fa-search-plus"></i>
                                Увеличить
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Загрузка нового изображения -->
                <div id="newImageUploadSection" style="display: none;">
                    <div class="form-group full-width mt-3">
                        <label>Новое изображение</label>
                        <div class="file-upload-container" id="editDropZone">
                            <input type="file" name="ImageFile" id="editImageFile" accept="image/*" class="file-input">
                            <div class="file-upload-preview" id="editImagePreview">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Выберите новый файл или перетащите сюда</span>
                            </div>
                            <div class="file-name" id="editFileName"></div>
                        </div>

                        <div class="upload-progress" id="editUploadProgress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="editProgressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="editProgressText">0%</div>
                        </div>

                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            • Форматы: PNG, JPG, JPEG, GIF, WEBP<br>
                            • Макс. размер: 5MB
                        </small>
                    </div>
                </div>

                <!-- Дополнительные опции -->
                <div class="form-group checkbox-group mt-3">
                    <label>
                        <input type="checkbox" name="IsPopular" id="editIsPopular" value="true">
                        Популярное
                    </label>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="IsNew" id="editIsNew" value="true">
                        Новинка
                    </label>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="IsAvailable" id="editIsAvailable" value="true" checked>
                        Доступно
                    </label>
                </div>
            </div>

            <!-- Вкладка Характеристики -->
            <div class="tab-pane" id="edit-specs">
                <div class="coffee-fields">
                    <h4 class="mb-3">Характеристики напитка</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Температура</label>
                            <input type="text" name="Temperature" id="editTemperature" class="form-control">
                        </div>

                        <div class="form-group">
                            <label>Объем</label>
                            <input type="text" name="Volume" id="editVolume" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="dessert-fields">
                    <h4 class="mb-3">Характеристики десерта</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Вес</label>
                            <input type="text" name="Weight" id="editWeight" class="form-control">
                        </div>

                        <div class="form-group">
                            <label>Время приготовления (мин)</label>
                            <input type="number" name="PrepTime" id="editPrepTime" class="form-control" min="1">
                        </div>
                    </div>

                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" name="ContainsNuts" id="editContainsNuts" value="true">
                            Содержит орехи
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeEditModal()">Отмена</button>
                <button type="submit" class="btn-save" id="editSubmitBtn">Сохранить изменения</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для просмотра изображения -->
<div id="imageViewModal" class="image-modal">
    <span class="image-modal-close" onclick="closeImageView()">&times;</span>
    <img class="image-modal-content" id="fullImage">
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        const token = $('input[name="__RequestVerificationToken"]').val();

        function showToast(message, type = 'success') {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const toast = $(`
                <div class="toast-notification toast-${type}">
                    <i class="fas ${icons[type] || icons.success}"></i>
                    <span>${message}</span>
                </div>
            `);

            $('#toastContainer').append(toast);

            setTimeout(() => toast.addClass('show'), 10);
            setTimeout(() => {
                toast.removeClass('show');
                setTimeout(() => toast.remove(), 5000);
            }, 5000);
        }

        window.viewImage = function(category, imageName, itemName) {
            if (!imageName) {
                showToast('У этого элемента нет изображения', 'warning');
                return;
            }

            const imagePath = `/images/menu/${category}/${imageName}.png`;

            const img = new Image();
            img.onload = function() {
                $('#fullImage').attr('src', imagePath);
                $('#imageViewModal').show();
            };
            img.onerror = function() {
                showToast('Изображение не найдено', 'error');
            };
            img.src = imagePath;
        };

        window.viewFullImage = function() {
            const imageSrc = $('#currentImage').attr('src');
            if (imageSrc && imageSrc !== '' && imageSrc !== '#') {
                $('#fullImage').attr('src', imageSrc);
                $('#imageViewModal').show();
            }
        };

        window.closeImageView = function() {
            $('#imageViewModal').hide();
        };

        $(window).on('click', function(event) {
            if ($(event.target).hasClass('image-modal')) {
                closeImageView();
            }
        });

        // ===== ФИЛЬТРАЦИЯ ПО КАТЕГОРИЯМ =====
        $('.filter-btn').on('click', function() {
            $('.filter-btn').removeClass('active');
            $(this).addClass('active');

            const filter = $(this).data('filter');

            if (filter === 'all') {
                $('.menu-row').show();
            } else {
                $('.menu-row').hide();
                $(`.menu-row[data-category="${filter}"]`).show();
            }
        });

        // ===== ПРЕДПРОСМОТР ИЗОБРАЖЕНИЙ =====
        function setupFileUpload(inputId, previewId, fileNameId, progressId, progressFillId, progressTextId) {
            const input = $(`#${inputId}`);
            const dropZone = input.closest('.file-upload-container');
            const preview = $(`#${previewId}`);
            const fileNameSpan = $(`#${fileNameId}`);

            input.on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (!file.type.match('image.*')) {
                        showToast('Пожалуйста, выберите изображение', 'error');
                        $(this).val('');
                        preview.html(`
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Выберите файл или перетащите сюда</span>
                        `);
                        fileNameSpan.text('');
                        return;
                    }

                    if (file.size > 5 * 1024 * 1024) {
                        showToast('Файл слишком большой. Максимальный размер 5MB', 'error');
                        $(this).val('');
                        preview.html(`
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Выберите файл или перетащите сюда</span>
                        `);
                        fileNameSpan.text('');
                        return;
                    }

                    fileNameSpan.text(file.name);

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.html(`
                            <img src="${e.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 5px;">
                            <span style="margin-top: 5px;">${file.name}</span>
                        `);
                    };
                    reader.readAsDataURL(file);

                    $(`#${progressId}`).addClass('show');
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 10;
                        $(`#${progressFillId}`).css('width', progress + '%');
                        $(`#${progressTextId}`).text(progress + '%');

                        if (progress >= 100) {
                            clearInterval(interval);
                            setTimeout(() => {
                                $(`#${progressId}`).removeClass('show');
                            }, 500);
                        }
                    }, 50);
                }
            });

            dropZone.on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('dragover');
            });

            dropZone.on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('dragover');
            });

            dropZone.on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('dragover');

                const files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    const input = $(`#${inputId}`)[0];
                    input.files = files;
                    $(input).trigger('change');
                }
            });
        }

        // Инициализация загрузки файлов
        setupFileUpload('addImageFile', 'addImagePreview', 'addFileName', 'addUploadProgress', 'addProgressFill', 'addProgressText');
        setupFileUpload('editImageFile', 'editImagePreview', 'editFileName', 'editUploadProgress', 'editProgressFill', 'editProgressText');

        // ===== AJAX ЗАПРОСЫ ДЛЯ СТАТУСОВ =====
        window.togglePopular = function(id, element) {
            const badge = $(element);
            badge.addClass('loading');

            $.ajax({
                url: '/Admin/AdminMenu?handler=TogglePopular',
                type: 'POST',
                data: { id: id },
                headers: { 'RequestVerificationToken': token },
                success: function(response) {
                    if (badge.hasClass('popular')) {
                        badge.removeClass('popular').addClass('not-popular');
                        badge.html('<i class="far fa-star"></i>');
                        showToast('Убран из популярных', 'info');
                    } else {
                        badge.removeClass('not-popular').addClass('popular');
                        badge.html('<i class="fas fa-star"></i>');
                        showToast('Добавлен в популярные', 'success');
                    }
                },
                error: function() {
                    showToast('Ошибка при обновлении', 'error');
                },
                complete: function() {
                    badge.removeClass('loading');
                }
            });
        };

        window.toggleNew = function(id, element) {
            const badge = $(element);
            badge.addClass('loading');

            $.ajax({
                url: '/Admin/AdminMenu?handler=ToggleNew',
                type: 'POST',
                data: { id: id },
                headers: { 'RequestVerificationToken': token },
                success: function(response) {
                    if (badge.hasClass('new')) {
                        badge.removeClass('new').addClass('not-new');
                        badge.html('<i class="far fa-gem"></i>');
                        showToast('Убран из новинок', 'info');
                    } else {
                        badge.removeClass('not-new').addClass('new');
                        badge.html('<i class="fas fa-gem"></i>');
                        showToast('Добавлен в новинки', 'success');
                    }
                },
                error: function() {
                    showToast('Ошибка при обновлении', 'error');
                },
                complete: function() {
                    badge.removeClass('loading');
                }
            });
        };

        window.toggleAvailable = function(id, element) {
            const badge = $(element);
            badge.addClass('loading');

            $.ajax({
                url: '/Admin/AdminMenu?handler=ToggleAvailable',
                type: 'POST',
                data: { id: id },
                headers: { 'RequestVerificationToken': token },
                success: function(response) {
                    if (badge.hasClass('available')) {
                        badge.removeClass('available').addClass('not-available');
                        badge.html('<i class="fas fa-times-circle"></i>');
                        showToast('Товар недоступен', 'warning');
                    } else {
                        badge.removeClass('not-available').addClass('available');
                        badge.html('<i class="fas fa-check-circle"></i>');
                        showToast('Товар доступен', 'success');
                    }
                },
                error: function() {
                    showToast('Ошибка при обновлении', 'error');
                },
                complete: function() {
                    badge.removeClass('loading');
                }
            });
        };

        // ===== AJAX ДЛЯ УДАЛЕНИЯ =====
        window.confirmDelete = function(id, name) {
            if (confirm(`Вы уверены, что хотите удалить "${name}"?`)) {
                $.ajax({
                    url: '/Admin/AdminMenu?handler=Delete',
                    type: 'POST',
                    data: { id: id },
                    headers: { 'RequestVerificationToken': token },
                    success: function(response) {
                        $(`.menu-row[data-id="${id}"]`).fadeOut(300, function() {
                            $(this).remove();
                            showToast('Элемент удален', 'success');

                            if ($('.menu-row').length === 0) {
                                location.reload();
                            }
                        });
                    },
                    error: function() {
                        showToast('Ошибка при удалении', 'error');
                    }
                });
            }
        };

        // ===== AJAX ДЛЯ ДОБАВЛЕНИЯ =====
        $('#addForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $('#addSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Сохранение...');

            $.ajax({
                url: '/Admin/AdminMenu?handler=Add',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'RequestVerificationToken': token },
                success: function(response) {
                    if (response.success) {
                        closeAddModal();
                        showToast(response.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast(response.message, 'error');
                        $('#addSubmitBtn').prop('disabled', false).text('Сохранить');
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'Ошибка при добавлении';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    showToast(errorMessage, 'error');
                    $('#addSubmitBtn').prop('disabled', false).text('Сохранить');
                }
            });
        });

                $('#editForm').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const id = $('#editId').val();
            const imageAction = $('input[name="imageAction"]:checked').val();

            // ВАЖНО: добавляем действие с изображением в FormData
            formData.append('ImageAction', imageAction);

            // Если не выбрана загрузка нового файла, удаляем файл из FormData
            if (imageAction !== 'change') {
                formData.delete('ImageFile');
            }

            // Для отладки - выводим содержимое FormData
            console.log('ImageAction:', imageAction);
            console.log('FormData entries:');
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            $('#editSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Сохранение...');

            $.ajax({
                url: '/Admin/AdminMenu?handler=Edit&id=' + id,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'RequestVerificationToken': token },
                success: function(response) {
                    if (response.success) {
                        closeEditModal();
                        showToast(response.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast(response.message, 'error');
                        $('#editSubmitBtn').prop('disabled', false).text('Сохранить изменения');
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'Ошибка при обновлении';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    showToast(errorMessage, 'error');
                    $('#editSubmitBtn').prop('disabled', false).text('Сохранить изменения');
                }
            });
        });

        // ===== МОДАЛЬНЫЕ ОКНА =====
        window.openAddModal = function() {
            $('#addModal').show();
            $('#addForm')[0].reset();
            $('#addFileName').text('');
            $('#addImagePreview').html(`
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Выберите файл или перетащите сюда</span>
            `);

            $('.modal-tab').removeClass('active');
            $('.tab-pane').removeClass('active');
            $('.modal-tab[data-tab="add-basic"]').addClass('active');
            $('#add-basic').addClass('active');

            $('#addModal .coffee-fields, #addModal .dessert-fields').hide();
        };

        window.closeAddModal = function() {
            $('#addModal').hide();
        };

            window.openEditModal = function(item) {
            $('#editId').val(item.id);
            $('#editName').val(item.name);
            $('#editCategory').val(item.category);
            $('#editDescription').val(item.description || '');
            $('#editPrice').val(item.price);
            $('#editIsPopular').prop('checked', item.isPopular);
            $('#editIsNew').prop('checked', item.isNew);
            $('#editIsAvailable').prop('checked', item.isAvailable);
            $('#editTemperature').val(item.temperature || '');
            $('#editVolume').val(item.volume || '');
            $('#editWeight').val(item.weight || '');
            $('#editPrepTime').val(item.prepTime || '');
            $('#editContainsNuts').prop('checked', item.containsNuts);

            // ВАЖНО: Сбрасываем выбор действия с изображением на "keep"
            $('input[name="imageAction"][value="keep"]').prop('checked', true);
            $('#newImageUploadSection').hide();

            if (item.imageName) {
                const imagePath = `/images/menu/${item.category}/${item.imageName}.png`;
                $('#currentImage').attr('src', imagePath);
                $('#currentImageName').val(item.imageName);
                $('#currentImageSection').show();
                $('#imageStatusBadge').text('Есть').css('background', 'var(--success)');
            } else {
                $('#currentImage').attr('src', '');
                $('#currentImageName').val('');
                $('#currentImageSection').show();
                $('#imageStatusBadge').text('Нет').css('background', 'var(--warning)');
            }

            $('#editImageFile').val('');
            $('#editFileName').text('');
            $('#editImagePreview').html(`
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Выберите новый файл или перетащите сюда</span>
            `);

            $('.modal-tab').removeClass('active');
            $('.tab-pane').removeClass('active');
            $('.modal-tab[data-tab="edit-basic"]').addClass('active');
            $('#edit-basic').addClass('active');

            $('#editModal').show();
        };

        window.closeEditModal = function() {
            $('#editModal').hide();
        };

        $(window).on('click', function(event) {
            if ($(event.target).hasClass('modal')) {
                $(event.target).hide();
            }
        });

        $('.modal-tab').on('click', function() {
            const tabId = $(this).data('tab');

            $(this).closest('.modal-content').find('.modal-tab').removeClass('active');
            $(this).addClass('active');

            $(this).closest('.modal-content').find('.tab-pane').removeClass('active');
            $('#' + tabId).addClass('active');
        });

        $('#addCategory').on('change', function() {
            const category = $(this).val();
            $('#addModal .coffee-fields, #addModal .dessert-fields').hide();

            if (category === 'coffee' || category === 'tea') {
                $('#addModal .coffee-fields').show();
            } else if (category === 'dessert') {
                $('#addModal .dessert-fields').show();
            }
        });

        $('#editCategory').on('change', function() {
            const category = $(this).val();
            $('#editModal .coffee-fields, #editModal .dessert-fields').hide();

            if (category === 'coffee' || category === 'tea') {
                $('#editModal .coffee-fields').show();
            } else if (category === 'dessert') {
                $('#editModal .dessert-fields').show();
            }
        });

                $('input[name="imageAction"]').on('change', function() {
            const action = $(this).val();

            // Сбрасываем предыдущий выбор файла
            $('#editImageFile').val('');
            $('#editFileName').text('');
            $('#editImagePreview').html(`
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Выберите новый файл или перетащите сюда</span>
            `);

            if (action === 'change') {
                $('#newImageUploadSection').show();
            } else {
                $('#newImageUploadSection').hide();
            }

            // Если выбрано удаление, показываем подтверждение
            if (action === 'delete') {
                if (!confirm('Вы уверены, что хотите удалить изображение?')) {
                    $('input[name="imageAction"][value="keep"]').prop('checked', true);
                    $('#newImageUploadSection').hide();
                }
            }
        });

        $('.modal-content').on('click', function(e) {
            e.stopPropagation();
        });

        $(document).on('keydown', function(e) {
            if (e.key === 'Escape') {
                if ($('#addModal').is(':visible')) closeAddModal();
                if ($('#editModal').is(':visible')) closeEditModal();
                if ($('#imageViewModal').is(':visible')) closeImageView();
            }
        });

        $(document).ready(function() {
            $('#addCategory').trigger('change');
        });
    </script>
}

=== Program.cs ===
using Microsoft.EntityFrameworkCore;
using Roast___Rest.Data;
using Roast___Rest.Extensions;
using Roast___Rest.Services;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Http.Features;

var builder = WebApplication.CreateBuilder(args);

// Увеличиваем лимиты для загрузки файлов
builder.Services.Configure<FormOptions>(options =>
{
    options.ValueLengthLimit = int.MaxValue;
    options.MultipartBodyLengthLimit = 10 * 1024 * 1024; // 10MB
    options.MemoryBufferThreshold = int.MaxValue;
});

// Настройка Kestrel для больших файлов
builder.WebHost.ConfigureKestrel(options =>
{
    options.Limits.MaxRequestBodySize = 10 * 1024 * 1024; // 10MB
});

// Настройка базы данных
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlite("Data Source=roastrest.db"));

// Поддержка Razor Pages
builder.Services.AddRazorPages();

// Аутентификация через cookies
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = "/Login";
        options.LogoutPath = "/";
        options.AccessDeniedPath = "/";
        options.ExpireTimeSpan = TimeSpan.FromDays(7);
        options.SlidingExpiration = true;
        options.Cookie.Name = ".RoastRest.Auth";
        options.Cookie.HttpOnly = true;
        options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest;
        options.Cookie.SameSite = SameSiteMode.Lax;
    });

// Авторизация
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin"));
});

// Сессии
builder.Services.AddDistributedMemoryCache();
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromDays(7);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
    options.Cookie.Name = ".RoastRest.Session";
});

// Внедрение HttpContext
builder.Services.AddHttpContextAccessor();

// Ваши сервисы
builder.Services.AddScoped<IDatabaseService, DatabaseService>();
builder.Services.AddScoped<IImageService, ImageService>();

var app = builder.Build();

// Создание базы данных и начальные данные
using (var scope = app.Services.CreateScope())
{
    var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
    dbContext.Database.EnsureCreated();

    await SeedData.Initialize(scope.ServiceProvider);
}

// Обработка ошибок и HTTPS
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseSession();
app.UseAuthentication();
app.UseAuthorization();

app.MapRazorPages();

app.Run();

=== appsettings.json ===
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}

=== Menu.cshtml === 
@page
@model Roast___Rest.Pages.MenuModel
@{
    ViewData["Title"] = "Меню Roast & Rest";
}

<!-- Подключаем те же шрифты, что и на About.cshtml и Index.cshtml -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<div class="menu-page">
    <div class="container py-5">
        <!-- Заголовок страницы в стиле About.cshtml -->
        <div class="text-center mb-5 animate-on-scroll">
            <h1 class="menu-title">НАШЕ МЕНЮ</h1>
            <p class="menu-subtitle">Откройте для себя вкус, который вас вдохновит</p>
        </div>

        <!-- Навигация по категориям в стиле премиум -->
        <div class="category-nav-wrapper animate-on-scroll">
            <div class="category-nav">
                <button class="category-btn active" data-category="coffee">
                    <span class="category-icon">☕</span>
                    <span class="category-name">Кофе</span>
                </button>
                <button class="category-btn" data-category="tea">
                    <span class="category-icon">🍵</span>
                    <span class="category-name">Чай</span>
                </button>
                <button class="category-btn" data-category="desserts">
                    <span class="category-icon">🍰</span>
                    <span class="category-name">Десерты</span>
                </button>
            </div>
        </div>

        <!-- Секции меню -->
        <div class="menu-sections-container">
            <!-- Раздел Кофе -->
            <div class="menu-section active" id="coffee-section">
                <div class="row g-4">
                    @foreach (var coffee in Model.CoffeeItems)
                    {
                        <div class="col-lg-4 col-md-6 fade-in-section" style="animation-delay: @(Model.CoffeeItems.IndexOf(coffee) * 0.1)s">
                            <div class="menu-card coffee-card" data-name="@coffee.Name" data-price="@coffee.Price" data-category="кофе" data-image="@coffee.ImageName" data-description="@coffee.Description">
                                <div class="menu-card-image-wrapper">
                                    <div class="menu-card-image">
                                        <img src="/images/menu/coffee/@(coffee.ImageName).png"
                                             class="menu-img"
                                             alt="@coffee.Name"
                                             loading="lazy"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'menu-img-placeholder\'><i class=\'fas fa-mug-hot\'></i></div>'">
                                    </div>
                                    @if (coffee.IsPopular)
                                    {
                                        <span class="badge-popular">Популярное</span>
                                    }
                                    @if (coffee.IsNew)
                                    {
                                        <span class="badge-new">Новинка</span>
                                    }
                                </div>
                                <div class="menu-card-content">
                                    <h3 class="menu-item-title">@coffee.Name</h3>
                                    <p class="menu-item-desc">@coffee.Description</p>

                                    <div class="menu-item-specs">
                                        <div class="spec-item">
                                            <div class="spec-icon">
                                                <i class="fas fa-thermometer-half"></i>
                                            </div>
                                            <div class="spec-info">
                                                <span class="spec-value">@coffee.Temperature</span>
                                                <span class="spec-label">температура</span>
                                            </div>
                                        </div>
                                        <div class="spec-item">
                                            <div class="spec-icon">
                                                <i class="fas fa-glass-whiskey"></i>
                                            </div>
                                            <div class="spec-info">
                                                <span class="spec-value">@coffee.Volume</span>
                                                <span class="spec-label">объём</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="menu-card-footer">
                                        <div class="menu-item-price">@coffee.Price ₽</div>
                                        <button class="btn-add-to-cart">
                                            <i class="fas fa-plus"></i>
                                            <span>В корзину</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Раздел Чай -->
            <div class="menu-section" id="tea-section">
                <div class="row g-4">
                    @foreach (var tea in Model.TeaItems)
                    {
                        <div class="col-lg-4 col-md-6 fade-in-section" style="animation-delay: @(Model.TeaItems.IndexOf(tea) * 0.1)s">
                            <div class="menu-card tea-card" data-name="@tea.Name" data-price="@tea.Price" data-category="чай" data-image="@tea.ImageName" data-description="@tea.Description">
                                <div class="menu-card-image-wrapper">
                                    <div class="menu-card-image">
                                        <img src="/images/menu/tea/@(tea.ImageName).png"
                                             class="menu-img"
                                             alt="@tea.Name"
                                             loading="lazy"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'menu-img-placeholder\'><i class=\'fas fa-leaf\'></i></div>'">
                                    </div>
                                    @if (tea.IsPopular)
                                    {
                                        <span class="badge-popular">Популярное</span>
                                    }
                                    @if (tea.IsNew)
                                    {
                                        <span class="badge-new">Новинка</span>
                                    }
                                </div>
                                <div class="menu-card-content">
                                    <h3 class="menu-item-title tea-title">@tea.Name</h3>
                                    <p class="menu-item-desc">@tea.Description</p>

                                    <div class="menu-item-specs">
                                        <div class="spec-item">
                                            <div class="spec-icon tea-icon">
                                                <i class="fas fa-thermometer-half"></i>
                                            </div>
                                            <div class="spec-info">
                                                <span class="spec-value tea-value">@tea.Temperature</span>
                                                <span class="spec-label">температура</span>
                                            </div>
                                        </div>
                                        <div class="spec-item">
                                            <div class="spec-icon tea-icon">
                                                <i class="fas fa-glass-whiskey"></i>
                                            </div>
                                            <div class="spec-info">
                                                <span class="spec-value tea-value">@tea.Volume</span>
                                                <span class="spec-label">объём</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="menu-card-footer">
                                        <div class="menu-item-price tea-price">@tea.Price ₽</div>
                                        <button class="btn-add-to-cart tea-btn">
                                            <i class="fas fa-plus"></i>
                                            <span>В корзину</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Раздел Десерты -->
            <div class="menu-section" id="desserts-section">
                <div class="row g-4">
                    @foreach (var dessert in Model.DessertItems)
                    {
                        <div class="col-lg-4 col-md-6 fade-in-section" style="animation-delay: @(Model.DessertItems.IndexOf(dessert) * 0.1)s">
                            <div class="menu-card dessert-card" data-name="@dessert.Name" data-price="@dessert.Price" data-category="десерты" data-image="@dessert.ImageName" data-description="@dessert.Description">
                                <div class="menu-card-image-wrapper">
                                    <div class="menu-card-image">
                                        <img src="/images/menu/dessert/@(dessert.ImageName).png"
                                             class="menu-img"
                                             alt="@dessert.Name"
                                             loading="lazy"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'menu-img-placeholder\'><i class=\'fas fa-birthday-cake\'></i></div>'">
                                    </div>
                                    @if (dessert.IsPopular)
                                    {
                                        <span class="badge-popular">Популярное</span>
                                    }
                                    @if (dessert.IsNew)
                                    {
                                        <span class="badge-new">Новинка</span>
                                    }
                                </div>
                                <div class="menu-card-content">
                                    <h3 class="menu-item-title dessert-title">@dessert.Name</h3>
                                    <p class="menu-item-desc">@dessert.Description</p>

                                    <div class="menu-item-specs">
                                        <div class="spec-item">
                                            <div class="spec-icon dessert-icon">
                                                <i class="fas fa-weight"></i>
                                            </div>
                                            <div class="spec-info">
                                                <span class="spec-value dessert-value">@dessert.Weight</span>
                                                <span class="spec-label">вес</span>
                                            </div>
                                        </div>
                                        <div class="spec-item">
                                            <div class="spec-icon dessert-icon">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="spec-info">
                                                <span class="spec-value dessert-value">@dessert.PrepTime мин</span>
                                                <span class="spec-label">приготовление</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="menu-card-footer">
                                        <div class="menu-item-price dessert-price">@dessert.Price ₽</div>
                                        <button class="btn-add-to-cart dessert-btn">
                                            <i class="fas fa-plus"></i>
                                            <span>В корзину</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Декоративная навигация в стиле Index.cshtml -->
        <div class="pagination-wrapper text-center mt-5 animate-on-scroll">
            <div class="elegant-pagination">
                <button class="pagination-arrow prev-arrow" id="prevCategory">
                    <i class="fas fa-chevron-left"></i>
                    <span class="arrow-text" id="prevLabel">Десерты</span>
                </button>

                <div class="pagination-dots">
                    <span class="pagination-dot active" data-category="coffee"></span>
                    <span class="pagination-dot" data-category="tea"></span>
                    <span class="pagination-dot" data-category="desserts"></span>
                </div>

                <button class="pagination-arrow next-arrow" id="nextCategory">
                    <span class="arrow-text" id="nextLabel">Чай</span>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* === ЕДИНЫЙ СТИЛЬ С INDEX.CSHTML И ABOUT.CSHTML === */
    :root {
        --primary: #D4A76A;
        --secondary: #8B4513;
        --dark: #2C1810;
        --light: #F9F5F0;
        --text-dark: #3F2723;
        --text-light: #5C4E3D;
        --coffee: #5D4037;
        --tea: #2E7D32;
        --dessert: #6A1B9A;
    }

    body {
        font-family: 'Inter', sans-serif;
        color: var(--text-dark);
        background-color: var(--light);
        line-height: 1.6;
    }

    .menu-page {
        background: linear-gradient(to bottom, #FFF9F5 0%, #FFFFFF 100%);
        min-height: 100vh;
    }

    /* === ЗАГОЛОВКИ В СТИЛЕ ABOUT.CSHTML === */
    .menu-title {
        font-family: 'Playfair Display', serif;
        font-size: 4rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1rem;
        letter-spacing: -0.5px;
        background: linear-gradient(45deg, var(--dark), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .menu-subtitle {
        font-family: 'Inter', sans-serif;
        font-size: 1.2rem;
        font-weight: 300;
        color: var(--text-light);
        letter-spacing: 1px;
    }

    /* === НАВИГАЦИЯ ПО КАТЕГОРИЯМ В СТИЛЕ ПРЕМИУМ === */
    .category-nav-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 3rem;
    }

    .category-nav {
        display: inline-flex;
        background: white;
        padding: 0.5rem;
        border-radius: 50px;
        box-shadow: 0 10px 30px rgba(139, 69, 19, 0.08);
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .category-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 28px;
        border: none;
        background: transparent;
        border-radius: 40px;
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-light);
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .category-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 8px 20px rgba(212, 167, 106, 0.3);
        }

            .category-btn.active .category-icon {
                color: white;
            }

    .category-icon {
        font-size: 1.2rem;
        color: var(--primary);
        transition: color 0.3s ease;
    }

    .category-name {
        font-weight: 600;
    }

    /* === КАРТОЧКИ МЕНЮ В СТИЛЕ INDEX.CSHTML === */
    .menu-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(139, 69, 19, 0.05);
        height: 100%;
        display: flex;
        flex-direction: column;
        opacity: 0;
        transform: translateY(30px);
        animation: cardAppear 0.6s ease forwards;
    }

    @@keyframes cardAppear {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .menu-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(139, 69, 19, 0.15);
    }

    .menu-card-image-wrapper {
        position: relative;
        overflow: hidden;
    }

    .menu-card-image {
        position: relative;
        width: 100%;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        background: linear-gradient(45deg, var(--light), #fff);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
    }

    .menu-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: transform 0.5s ease;
        padding: 0.5rem;
    }

    .menu-card:hover .menu-img {
        transform: scale(1.05);
    }

    .menu-img-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: var(--primary);
        background: linear-gradient(45deg, var(--light), #fff);
    }

    .badge-popular,
    .badge-new {
        position: absolute;
        top: 20px;
        left: -5px;
        padding: 8px 20px;
        font-family: 'Inter', sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 0 20px 20px 0;
        z-index: 3;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .badge-popular {
        background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
    }

    .badge-new {
        background: linear-gradient(135deg, #4ECDC4, #66E0D9);
    }

    .menu-card-content {
        padding: 1.8rem 1.5rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .menu-item-title {
        font-family: 'Playfair Display', serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 0.8rem;
        line-height: 1.3;
    }

    .tea-title {
        color: var(--tea);
    }

    .dessert-title {
        color: var(--dessert);
    }

    .menu-item-desc {
        font-family: 'Open Sans', sans-serif;
        font-size: 0.9rem;
        color: var(--text-light);
        line-height: 1.6;
        margin-bottom: 1.2rem;
        flex-grow: 1;
    }

    /* === СПЕЦИФИКАЦИИ В СТИЛЕ DRINK-CARD === */
    .menu-item-specs {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 1.5rem;
    }

    .spec-item {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        padding: 0.8rem;
        background: var(--light);
        border-radius: 12px;
        border: 1px solid rgba(139, 69, 19, 0.05);
    }

    .spec-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 10px;
        color: var(--primary);
        font-size: 1.1rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
    }

    .tea-icon {
        color: var(--tea);
    }

    .dessert-icon {
        color: var(--dessert);
    }

    .spec-info {
        display: flex;
        flex-direction: column;
    }

    .spec-value {
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 2px;
    }

    .tea-value {
        color: var(--tea);
    }

    .dessert-value {
        color: var(--dessert);
    }

    .spec-label {
        font-family: 'Open Sans', sans-serif;
        font-size: 0.7rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
    }

    /* === ФУТЕР КАРТОЧКИ === */
    .menu-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(139, 69, 19, 0.1);
    }

    .menu-item-price {
        font-family: 'Playfair Display', serif;
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--primary);
        line-height: 1;
    }

    .tea-price {
        color: var(--tea);
    }

    .dessert-price {
        color: var(--dessert);
    }

    .btn-add-to-cart {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border: none;
        background: var(--primary);
        color: white;
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 30px;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 8px 15px rgba(212, 167, 106, 0.2);
    }

        .btn-add-to-cart:hover:not(:disabled) {
            background: #E6B87E;
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(212, 167, 106, 0.3);
        }

        .btn-add-to-cart:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-add-to-cart i {
            font-size: 0.8rem;
        }

    .tea-btn {
        background: var(--tea);
        box-shadow: 0 8px 15px rgba(46, 125, 50, 0.2);
    }

        .tea-btn:hover:not(:disabled) {
            background: #3E9142;
        }

    .dessert-btn {
        background: var(--dessert);
        box-shadow: 0 8px 15px rgba(106, 27, 154, 0.2);
    }

        .dessert-btn:hover:not(:disabled) {
            background: #7B1FA2;
        }

    /* === НАВИГАЦИЯ В СТИЛЕ INDEX.CSHTML === */
    .pagination-wrapper {
        margin-top: 4rem !important;
    }

    .elegant-pagination {
        display: inline-flex;
        align-items: center;
        gap: 30px;
        padding: 15px 30px;
        background: white;
        border-radius: 50px;
        box-shadow: 0 10px 30px rgba(139, 69, 19, 0.08);
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .pagination-arrow {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 20px;
        border: none;
        background: transparent;
        border-radius: 30px;
        color: var(--text-light);
        font-family: 'Inter', sans-serif;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .pagination-arrow:hover {
            background: rgba(212, 167, 106, 0.1);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .pagination-arrow i {
            color: var(--primary);
            font-size: 0.9rem;
        }

    .arrow-text {
        font-weight: 600;
    }

    .pagination-dots {
        display: flex;
        gap: 15px;
    }

    .pagination-dot {
        width: 10px;
        height: 10px;
        background: rgba(139, 69, 19, 0.2);
        border-radius: 50%;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .pagination-dot.active {
            background: var(--primary);
            transform: scale(1.3);
            box-shadow: 0 0 0 3px rgba(212, 167, 106, 0.2);
        }

        .pagination-dot:hover {
            background: var(--primary);
            transform: scale(1.2);
        }

    /* === АНИМАЦИИ === */
    .animate-on-scroll {
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.8s ease forwards;
    }

    @@keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in-section {
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.8s ease forwards;
    }

    .menu-section {
        display: none;
    }

        .menu-section.active {
            display: block;
        }

    /* === АДАПТИВНОСТЬ === */
    @@media (max-width: 992px) {
        .menu-title {
            font-size: 3.5rem;
        }

        .category-btn {
            padding: 10px 22px;
        }

        .menu-item-specs {
            flex-direction: column;
            gap: 10px;
        }

        .spec-item {
            width: 100%;
        }
    }

    @@media (max-width: 768px) {
        .menu-title {
            font-size: 2.8rem;
        }

        .menu-subtitle {
            font-size: 1.1rem;
        }

        .category-nav {
            flex-wrap: wrap;
            justify-content: center;
            max-width: 400px;
        }

        .category-btn {
            padding: 8px 18px;
            font-size: 0.9rem;
        }

        .menu-card-image {
            padding: 1rem;
        }

        .menu-item-title {
            font-size: 1.2rem;
        }

        .menu-item-price {
            font-size: 1.4rem;
        }

        .btn-add-to-cart {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .elegant-pagination {
            padding: 12px 20px;
            gap: 20px;
        }

        .pagination-arrow {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .arrow-text {
            display: none;
        }

        .pagination-arrow i {
            font-size: 1.1rem;
        }
    }

    @@media (max-width: 576px) {
        .menu-title {
            font-size: 2.2rem;
        }

        .menu-subtitle {
            font-size: 1rem;
        }

        .category-nav {
            max-width: 300px;
        }

        .category-btn {
            padding: 8px 12px;
            gap: 6px;
        }

        .category-icon {
            font-size: 1rem;
        }

        .category-name {
            font-size: 0.85rem;
        }

        .menu-card-content {
            padding: 1.5rem 1.2rem;
        }

        .menu-item-desc {
            font-size: 0.85rem;
        }

        .spec-item {
            padding: 0.6rem;
        }

        .spec-icon {
            width: 35px;
            height: 35px;
            font-size: 1rem;
        }

        .spec-value {
            font-size: 0.9rem;
        }

        .menu-card-footer {
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
        }

        .menu-item-price {
            text-align: center;
        }

        .btn-add-to-cart {
            justify-content: center;
        }

        .elegant-pagination {
            padding: 10px 15px;
        }

        .pagination-dots {
            gap: 12px;
        }
    }

    @@media (max-width: 375px) {
        .menu-title {
            font-size: 1.8rem;
        }

        .category-nav {
            max-width: 260px;
        }

        .category-btn {
            padding: 6px 10px;
        }

        .category-name {
            font-size: 0.8rem;
        }
    }

    /* === УЛУЧШЕНИЯ ДЛЯ СЕНСОРНЫХ УСТРОЙСТВ === */
    @@media (hover: none) and (pointer: coarse) {
        .menu-card:hover {
            transform: none;
        }

        .menu-card:active {
            transform: scale(0.98);
        }

        .btn-add-to-cart:hover {
            transform: none;
        }

        .btn-add-to-cart:active {
            transform: scale(0.95);
        }

        .pagination-arrow:hover {
            background: transparent;
            transform: none;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Навигация по категориям
        const sections = ['coffee', 'tea', 'desserts'];
        let currentIndex = 0;

        const sectionElements = {
            coffee: document.getElementById('coffee-section'),
            tea: document.getElementById('tea-section'),
            desserts: document.getElementById('desserts-section')
        };

        const categoryBtns = document.querySelectorAll('.category-btn');
        const dots = document.querySelectorAll('.pagination-dot');
        const prevBtn = document.getElementById('prevCategory');
        const nextBtn = document.getElementById('nextCategory');
        const prevLabel = document.getElementById('prevLabel');
        const nextLabel = document.getElementById('nextLabel');

        function switchCategory(category) {
            // Скрываем все секции
            Object.values(sectionElements).forEach(section => {
                section.classList.remove('active');
            });

            // Показываем выбранную секцию
            sectionElements[category].classList.add('active');

            // Обновляем кнопки категорий
            categoryBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                }
            });

            // Обновляем точки
            dots.forEach(dot => {
                dot.classList.remove('active');
                if (dot.dataset.category === category) {
                    dot.classList.add('active');
                }
            });

            // Обновляем индексы и подписи
            currentIndex = sections.indexOf(category);
            updateLabels(category);
        }

        function updateLabels(current) {
            const prevIndex = (currentIndex - 1 + sections.length) % sections.length;
            const nextIndex = (currentIndex + 1) % sections.length;

            const prevCategory = sections[prevIndex];
            const nextCategory = sections[nextIndex];

            const categoryNames = {
                coffee: 'Кофе',
                tea: 'Чай',
                desserts: 'Десерты'
            };

            prevLabel.textContent = categoryNames[prevCategory];
            nextLabel.textContent = categoryNames[nextCategory];
        }

        // Обработчики для кнопок категорий
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const category = this.dataset.category;
                switchCategory(category);
            });
        });

        // Обработчики для точек
        dots.forEach(dot => {
            dot.addEventListener('click', function () {
                const category = this.dataset.category;
                switchCategory(category);
            });
        });

        // Обработчики для стрелок
        prevBtn.addEventListener('click', function () {
            const prevIndex = (currentIndex - 1 + sections.length) % sections.length;
            switchCategory(sections[prevIndex]);
        });

        nextBtn.addEventListener('click', function () {
            const nextIndex = (currentIndex + 1) % sections.length;
            switchCategory(sections[nextIndex]);
        });

        // Клавиатурная навигация
        document.addEventListener('keydown', function (e) {
            if (e.key === 'ArrowLeft') {
                const prevIndex = (currentIndex - 1 + sections.length) % sections.length;
                switchCategory(sections[prevIndex]);
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                const nextIndex = (currentIndex + 1) % sections.length;
                switchCategory(sections[nextIndex]);
                e.preventDefault();
            }
        });

        // Инициализация
        switchCategory('coffee');

        // === ИСПРАВЛЕННАЯ ФУНКЦИЯ ДОБАВЛЕНИЯ В КОРЗИНУ ===
        let isAddingToCart = false;

        function handleAddToCart(e) {
            e.preventDefault();
            e.stopPropagation();

            // Защита от множественных кликов
            if (isAddingToCart) return;
            if (this.disabled) return;

            isAddingToCart = true;
            this.disabled = true;

            // Возвращаем возможность клика через 500мс
            setTimeout(() => {
                isAddingToCart = false;
                this.disabled = false;
            }, 500);

            const card = this.closest('.menu-card');
            
            // Получаем данные из карточки
            const name = card.dataset.name || card.querySelector('.menu-item-title').textContent;
            const priceText = card.querySelector('.menu-item-price').textContent;
            const price = parseInt(priceText.replace('₽', '').trim());
            
            // Определяем категорию
            let category = 'кофе';
            if (card.classList.contains('tea-card')) {
                category = 'чай';
            } else if (card.classList.contains('dessert-card')) {
                category = 'десерты';
            }
            
            const imageName = card.dataset.image || getImageName(card);
            const description = card.dataset.description || card.querySelector('.menu-item-desc')?.textContent || '';

            // Вызываем глобальную функцию addToCart
            if (window.addToCart) {
                window.addToCart(name, name, price, category, imageName, description);
            } else {
                console.error('Функция addToCart не найдена');
                // Резервная функция
                addToCartFallback(name, price, category, imageName, description);
            }
        }

        function getImageName(card) {
            const img = card.querySelector('.menu-img');
            if (img && img.src) {
                const parts = img.src.split('/');
                const filename = parts[parts.length - 1];
                return filename.replace('.png', '');
            }
            return 'placeholder';
        }

        // Резервная функция добавления в корзину
        function addToCartFallback(name, price, category, imageName, description) {
            let cart = JSON.parse(sessionStorage.getItem('cart') || '{"items":[],"totalItems":0,"totalPrice":0}');
            
            if (!cart.items) cart.items = [];

            const existingItemIndex = cart.items.findIndex(i => i.name === name);

            if (existingItemIndex !== -1) {
                cart.items[existingItemIndex].quantity = (cart.items[existingItemIndex].quantity || 1) + 1;
                showNotification(`Количество ${name} увеличено`, 'success');
            } else {
                cart.items.push({
                    id: name.replace(/\s+/g, '-').toLowerCase(),
                    name: name,
                    price: price,
                    category: category,
                    imageName: imageName,
                    quantity: 1,
                    description: description || ''
                });
                showNotification(`${name} добавлен в корзину`, 'success');
            }

            cart.totalItems = cart.items.reduce((sum, item) => sum + (item.quantity || 1), 0);
            cart.totalPrice = cart.items.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);

            sessionStorage.setItem('cart', JSON.stringify(cart));
            
            // Обновляем бейдж
            updateCartBadgeFallback();
        }

        function showNotification(message, type = 'success') {
            // Проверяем, не существует ли уже функция showNotification глобально
            if (window.showNotification) {
                window.showNotification(message, type);
                return;
            }
            
            // Создаем уведомление
            const toast = document.createElement('div');
            toast.className = `notification-toast notification-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateCartBadgeFallback() {
            const cart = JSON.parse(sessionStorage.getItem('cart') || '{"totalItems":0}');
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = cart.totalItems;
                badge.style.display = cart.totalItems > 0 ? 'inline' : 'none';
            }
        }

        // Добавляем стили для уведомлений, если их нет
        if (!document.querySelector('#notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                .notification-toast {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: white;
                    border-left: 4px solid var(--primary);
                    border-radius: 8px;
                    padding: 15px 25px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    transform: translateX(400px);
                    transition: transform 0.3s ease;
                    z-index: 9999;
                    font-family: 'Inter', sans-serif;
                }
                .notification-toast.show {
                    transform: translateX(0);
                }
                .notification-success {
                    border-left-color: #28a745;
                }
                .notification-success i {
                    color: #28a745;
                }
                .notification-toast i {
                    font-size: 1.2rem;
                }
                .notification-toast span {
                    font-size: 0.95rem;
                    color: var(--text-dark);
                }
            `;
            document.head.appendChild(style);
        }

        // Назначаем обработчики на кнопки
        const addToCartButtons = document.querySelectorAll('.btn-add-to-cart');
        addToCartButtons.forEach(btn => {
            // Удаляем старые обработчики
            btn.removeEventListener('click', handleAddToCart);
            // Добавляем новый обработчик
            btn.addEventListener('click', handleAddToCart);
        });
    });
</script> using Microsoft.AspNetCore.Mvc.RazorPages;
using Roast___Rest.Services;

namespace Roast___Rest.Pages
{
    public class MenuModel : PageModel
    {
        private readonly IDatabaseService _dbService;

        public MenuModel(IDatabaseService dbService)
        {
            _dbService = dbService;
        }

        public List<CoffeeItemViewModel> CoffeeItems { get; set; } = new();
        public List<TeaItemViewModel> TeaItems { get; set; } = new();
        public List<DessertItemViewModel> DessertItems { get; set; } = new();

        public async Task OnGetAsync()
        {
            var menuItems = await _dbService.GetMenuItems();

            // Группируем по категориям
            var coffeeDb = menuItems.Where(m => m.Category == "coffee").ToList();
            var teaDb = menuItems.Where(m => m.Category == "tea").ToList();
            var dessertDb = menuItems.Where(m => m.Category == "dessert").ToList();

            // Преобразуем в ViewModel
            CoffeeItems = coffeeDb.Select(m => new CoffeeItemViewModel
            {
                Name = m.Name,
                ImageName = m.ImageName ?? "",
                Description = m.Description ?? "",
                Price = m.Price,
                IsPopular = m.IsPopular,
                IsNew = m.IsNew,
                Temperature = m.Temperature ?? "85-90°C",
                Volume = m.Volume ?? "200 мл"
            }).ToList();

            TeaItems = teaDb.Select(m => new TeaItemViewModel
            {
                Name = m.Name,
                ImageName = m.ImageName ?? "",
                Description = m.Description ?? "",
                Price = m.Price,
                IsPopular = m.IsPopular,
                IsNew = m.IsNew,
                Temperature = m.Temperature ?? "75-80°C",
                Volume = m.Volume ?? "250 мл"
            }).ToList();

            DessertItems = dessertDb.Select(m => new DessertItemViewModel
            {
                Name = m.Name,
                ImageName = m.ImageName ?? "",
                Description = m.Description ?? "",
                Price = m.Price,
                IsPopular = m.IsPopular,
                IsNew = m.IsNew,
                Weight = m.Weight ?? "150 г",
                PrepTime = m.PrepTime ?? 10,
                ContainsNuts = m.ContainsNuts
            }).ToList();
        }
    }

    // ViewModel классы
    public class CoffeeItemViewModel
    {
        public string Name { get; set; } = string.Empty;
        public string ImageName { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public bool IsPopular { get; set; }
        public bool IsNew { get; set; }
        public string Temperature { get; set; } = "85-90°C";
        public string Volume { get; set; } = "200 мл";
    }

    public class TeaItemViewModel
    {
        public string Name { get; set; } = string.Empty;
        public string ImageName { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public bool IsPopular { get; set; }
        public bool IsNew { get; set; }
        public string Temperature { get; set; } = "75-80°C";
        public string Volume { get; set; } = "250 мл";
    }

    public class DessertItemViewModel
    {
        public string Name { get; set; } = string.Empty;
        public string ImageName { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public bool IsPopular { get; set; }
        public bool IsNew { get; set; }
        public string Weight { get; set; } = "150 г";
        public int PrepTime { get; set; } = 10;
        public bool ContainsNuts { get; set; }
    }
}

=== Auth.cshtml.cs === 
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Roast___Rest.Extensions;
using Roast___Rest.Services;
using System.Security.Claims;

namespace Roast___Rest.Pages.Api
{
    public class AuthModel : PageModel
    {
        private readonly IDatabaseService _dbService;

        public AuthModel(IDatabaseService dbService)
        {
            _dbService = dbService;
        }

        public async Task<IActionResult> OnPostLogout()
        {
            await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
            HttpContext.Session.ClearUser();
            return new JsonResult(new { success = true, message = "Выход выполнен успешно" });
        }

        public async Task<IActionResult> OnGetStatus()
        {
            var user = HttpContext.Session.GetUser();

            if (User.Identity?.IsAuthenticated == true && user == null)
            {
                // Восстанавливаем сессию из claims
                var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (!string.IsNullOrEmpty(userId) && int.TryParse(userId, out int id))
                {
                    var dbUser = await _dbService.GetUserById(id);
                    if (dbUser != null)
                    {
                        var roles = await _dbService.GetUserRoles(id);
                        user = new Models.UserSession
                        {
                            Id = dbUser.Id,
                            Name = dbUser.Name,
                            Email = dbUser.Email,
                            Phone = dbUser.Phone ?? "",
                            IsAuthenticated = true,
                            LastLogin = dbUser.LastLoginAt ?? DateTime.UtcNow,
                            Roles = roles
                        };
                        HttpContext.Session.SetUser(user);
                    }
                }
            }

            return new JsonResult(new
            {
                isAuthenticated = user?.IsAuthenticated ?? false,
                name = user?.Name,
                email = user?.Email
            });
        }

        public async Task<IActionResult> OnPostLogin(string email, string password, string phone, string loginType = "email")
        {
            string loginIdentifier = loginType == "email" ? email : phone;
            var user = await _dbService.AuthenticateUser(loginIdentifier, password, loginType);

            if (user != null)
            {
                var roles = await _dbService.GetUserRoles(user.Id);

                var userSession = new Models.UserSession
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone ?? "",
                    IsAuthenticated = true,
                    LastLogin = DateTime.UtcNow,
                    Roles = roles
                };

                HttpContext.Session.SetUser(userSession);

                return new JsonResult(new
                {
                    success = true,
                    user = new
                    {
                        name = user.Name,
                        email = user.Email
                    }
                });
            }

            return new JsonResult(new { success = false, message = "Неверный логин или пароль" });
        }
    }
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Roast & Rest</title>

    <!-- Подключение внешних ресурсов по HTTPS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Open+Sans:wght@300;400;600&family=Caveat:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body class="d-flex flex-column min-vh-100">

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" asp-page="/Index">
                <img src="~/лого.jpg" alt="Roast & Rest" class="logo-img" />
                <div class="d-flex flex-column">
                    <span class="brand-name">Roast & Rest</span>
                    <span class="brand-subtitle">Кофейня & Бейкери</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <!-- Навигационные ссылки -->
                    <li class="nav-item"><a class="nav-link" asp-page="/Index"><i class="fas fa-home"></i> <span>Главная</span></a></li>
                    <li class="nav-item"><a class="nav-link" asp-page="/About"><i class="fas fa-info-circle"></i> <span>О нас</span></a></li>
                    <li class="nav-item"><a class="nav-link" asp-page="/Menu"><i class="fas fa-utensils"></i> <span>Меню</span></a></li>
                    <li class="nav-item"><a class="nav-link" asp-page="/Booking"><i class="fas fa-calendar-alt"></i> <span>Бронирование</span></a></li>

                    @if (User.Identity.IsAuthenticated && User.IsInRole("Admin"))
                    {
                        <li class="nav-item"><a class="nav-link" asp-page="/Admin/AdminMenu"><i class="fas fa-cog"></i> <span>Админ</span></a></li>
                    }

                    <li class="nav-item ms-lg-3">
                        <a class="nav-link cart-link" asp-page="/Cart" title="Корзина">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
                        </a>
                    </li>

                    <li class="nav-item dropdown ms-lg-2">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i> <span>@User.Identity.Name</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/Profile"><i class="fas fa-user me-2"></i>Мой профиль</a></li>
                                <li><a class="dropdown-item" href="/Profile?tab=orders"><i class="fas fa-history me-2"></i>История заказов</a></li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <form method="post" asp-page="/Logout" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="dropdown-item text-danger"><i class="fas fa-sign-out-alt me-2"></i>Выйти</button>
                                    </form>
                                </li>
                            </ul>
                        }
                        else
                        {
                            <a class="nav-link d-flex align-items-center" asp-page="/Login">
                                <i class="fas fa-user-circle me-1"></i> <span>Войти</span>
                            </a>
                        }
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main role="main" class="flex-grow-1">
        @RenderBody()
    </main>

    <footer class="footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-5">
                    <div class="footer-logo-section">
                        <div class="footer-logo-container">
                            <img src="~/лого.jpg" alt="Roast & Rest" class="footer-logo-img">
                            <div class="footer-logo-text">
                                <span class="footer-brand-name">Roast & Rest</span>
                                <span class="footer-brand-subtitle">Кофейня с душой</span>
                            </div>
                        </div>
                        <p class="footer-description">
                            Место, где рождаются лучшие кофейные традиции.
                            Мы создаем не просто напитки, а атмосферу уюта,
                            тепла и настоящего отдыха.
                        </p>
                    </div>
                </div>

                <div class="col-lg-4 mb-5">
                    <div class="footer-section">
                        <h5 class="footer-title">
                            <i class="fas fa-address-book"></i>
                            Контакты
                        </h5>

                        <div class="footer-contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-location-dot"></i>
                            </div>
                            <div class="contact-details">
                                <span class="contact-label">Адрес</span>
                                <span class="contact-value">ул. Кофейная, 17, Кофеград</span>
                            </div>
                        </div>

                        <div class="footer-contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="contact-details">
                                <span class="contact-label">Телефон</span>
                                <span class="contact-value">+7 (999) 707-77-00</span>
                            </div>
                        </div>

                        <div class="footer-contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="contact-details">
                                <span class="contact-label">Email</span>
                                <span class="contact-value">pulse@love.ru</span>
                            </div>
                        </div>

                        <div class="footer-contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="contact-details">
                                <span class="contact-label">Часы работы</span>
                                <div class="contact-hours contact-value">
                                    <span>Пн-Чт: 9:00 - 22:00</span>
                                    <span>Пт-Сб: 9:30 - 21:00</span>
                                    <span>Вс: 10:00 - 20:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-5">
                    <div class="footer-section">
                        <h5 class="footer-title">
                            <i class="fas fa-share-alt"></i>
                            Мы в соцсетях
                        </h5>

                        <div class="social-links">
                            <a href="#" class="social-link" title="Instagram">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="#" class="social-link" title="VK">
                                <i class="fab fa-vk"></i>
                            </a>
                            <a href="#" class="social-link" title="Telegram">
                                <i class="fab fa-telegram"></i>
                            </a>
                            <a href="#" class="social-link" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>

                        <div class="mt-4">
                            <p style="color: var(--coffee-cream); font-size: 0.95rem;">
                                <i class="fas fa-mug-hot me-2"></i>
                                Подписывайтесь, чтобы быть в курсе всех акций и новинок!
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Нижняя часть футера -->
            <div class="footer-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        <p class="copyright mb-0">
                            &copy; @DateTime.Now.Year Roast & Rest. Все права защищены.
                        </p>
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <div class="footer-links">
                            <a href="#" class="footer-link">Политика конфиденциальности</a>
                            <a href="#" class="footer-link">Пользовательское соглашение</a>
                            <a href="#" class="footer-link">Контакты</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Скрипты Bootstrap и site.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html> using Microsoft.EntityFrameworkCore;
using Roast___Rest.Data;
using Roast___Rest.Models;
using Roast___Rest.Models.Database;
using System.Security.Cryptography;
using System.Text;
using DbOrder = Roast___Rest.Models.Database.Order;

namespace Roast___Rest.Services
{
    public class DatabaseService : IDatabaseService
    {
        private readonly AppDbContext _context;

        public DatabaseService(AppDbContext context)
        {
            _context = context;
        }

        // ========== ПОЛЬЗОВАТЕЛИ ==========
        public async Task<User?> GetUserByEmail(string email)
        {
            return await _context.Users
                .FirstOrDefaultAsync(u => u.Email == email && u.IsActive);
        }

        public async Task<User?> GetUserByPhone(string phone)
        {
            // Нормализуем телефон для поиска (убираем форматирование)
            var normalizedPhone = NormalizePhone(phone);
            return await _context.Users
                .FirstOrDefaultAsync(u => u.Phone != null &&
                    u.Phone.Replace(" ", "").Replace("-", "").Replace("(", "").Replace(")", "") == normalizedPhone
                    && u.IsActive);
        }

        public async Task<User?> GetUserById(int id)
        {
            return await _context.Users
                .FirstOrDefaultAsync(u => u.Id == id && u.IsActive);
        }

        public async Task<User> CreateUser(string name, string email, string phone, string password)
        {
            // Проверяем, не существует ли уже пользователь
            var existingUser = await _context.Users
                .FirstOrDefaultAsync(u => (u.Email == email && !string.IsNullOrEmpty(email)) ||
                                           (u.Phone == phone && !string.IsNullOrEmpty(phone)));

            if (existingUser != null)
            {
                throw new InvalidOperationException("Пользователь с таким email или телефоном уже существует");
            }

            var user = new User
            {
                Name = name,
                Email = email,
                Phone = phone,
                PasswordHash = HashPassword(password),
                CreatedAt = DateTime.UtcNow,
                IsActive = true
            };

            _context.Users.Add(user);
            await _context.SaveChangesAsync();
            return user;
        }

        public async Task<User?> UpdateUser(User user)
        {
            user.UpdatedAt = DateTime.UtcNow;
            _context.Users.Update(user);
            await _context.SaveChangesAsync();
            return user;
        }

        public async Task<User?> AuthenticateUser(string loginIdentifier, string password, string loginType)
        {
            User? user = null;

            if (loginType == "email")
            {
                user = await GetUserByEmail(loginIdentifier);
            }
            else if (loginType == "phone")
            {
                user = await GetUserByPhone(loginIdentifier);
            }

            if (user != null && VerifyPassword(password, user.PasswordHash))
            {
                // Обновляем время последнего входа
                user.LastLoginAt = DateTime.UtcNow;
                _context.Users.Update(user);
                await _context.SaveChangesAsync();

                return user;
            }

            return null;
        }

        // ========== РОЛИ ==========
        public async Task<List<string>> GetUserRoles(int userId)
        {
            return await _context.UserRoles
                .Where(ur => ur.UserId == userId)
                .Select(ur => ur.Role.Name)
                .ToListAsync();
        }

        public async Task<bool> IsUserInRole(int userId, string roleName)
        {
            return await _context.UserRoles
                .AnyAsync(ur => ur.UserId == userId && ur.Role.Name == roleName);
        }

        public async Task AddUserToRole(int userId, string roleName)
        {
            // Проверяем, существует ли роль
            var role = await _context.Roles.FirstOrDefaultAsync(r => r.Name == roleName);
            if (role == null)
            {
                role = new Role { Name = roleName };
                _context.Roles.Add(role);
                await _context.SaveChangesAsync();
            }

            // Проверяем, не назначена ли уже роль
            var existingUserRole = await _context.UserRoles
                .FirstOrDefaultAsync(ur => ur.UserId == userId && ur.RoleId == role.Id);

            if (existingUserRole == null)
            {
                var userRole = new UserRole
                {
                    UserId = userId,
                    RoleId = role.Id
                };
                _context.UserRoles.Add(userRole);
                await _context.SaveChangesAsync();
            }
        }

        public async Task RemoveUserFromRole(int userId, string roleName)
        {
            var userRole = await _context.UserRoles
                .Include(ur => ur.Role)
                .FirstOrDefaultAsync(ur => ur.UserId == userId && ur.Role.Name == roleName);

            if (userRole != null)
            {
                _context.UserRoles.Remove(userRole);
                await _context.SaveChangesAsync();
            }
        }

        // ========== ЗАКАЗЫ ==========
        public async Task<DbOrder> CreateOrder(DbOrder order)
        {
            if (order.Id == 0)
            {
                order.OrderNumber = await GenerateOrderNumber();
                order.OrderDate = DateTime.UtcNow;

                _context.Orders.Add(order);
                await _context.SaveChangesAsync();

                foreach (var item in order.Items)
                {
                    item.OrderId = order.Id;
                    _context.OrderItems.Add(item);
                }

                await _context.SaveChangesAsync();
            }

            return order;
        }

        public async Task<DbOrder?> GetOrderById(int id)
        {
            return await _context.Orders
                .Include(o => o.Items)
                .FirstOrDefaultAsync(o => o.Id == id);
        }

        public async Task<DbOrder?> GetOrderByNumber(string orderNumber)
        {
            return await _context.Orders
                .Include(o => o.Items)
                .FirstOrDefaultAsync(o => o.OrderNumber == orderNumber);
        }

        public async Task<List<DbOrder>> GetUserOrders(int userId)
        {
            return await _context.Orders
                .Include(o => o.Items)
                .Where(o => o.UserId == userId)
                .OrderByDescending(o => o.OrderDate)
                .ToListAsync();
        }

        public async Task<List<DbOrder>> GetGuestOrders(string guestToken)
        {
            return await _context.Orders
                .Include(o => o.Items)
                .Where(o => o.GuestToken == guestToken)
                .OrderByDescending(o => o.OrderDate)
                .ToListAsync();
        }

        public async Task<DbOrder?> UpdateOrderStatus(int orderId, OrderStatus status)
        {
            var order = await _context.Orders.FindAsync(orderId);
            if (order != null)
            {
                order.Status = status;
                await _context.SaveChangesAsync();
            }
            return order;
        }

        // ========== МЕНЮ ==========
        public async Task<List<MenuItem>> GetMenuItems(string? category = null)
        {
            var query = _context.MenuItems.Where(m => m.IsAvailable);

            if (!string.IsNullOrEmpty(category))
            {
                query = query.Where(m => m.Category == category);
            }

            return await query.OrderBy(m => m.Category).ThenBy(m => m.Name).ToListAsync();
        }

        public async Task<MenuItem?> GetMenuItemById(int id)
        {
            return await _context.MenuItems.FindAsync(id);
        }

        public async Task<MenuItem?> GetMenuItemByName(string name)
        {
            return await _context.MenuItems
                .FirstOrDefaultAsync(m => m.Name == name && m.IsAvailable);
        }

        public async Task<MenuItem> CreateMenuItem(MenuItem item)
        {
            item.CreatedAt = DateTime.UtcNow;
            _context.MenuItems.Add(item);
            await _context.SaveChangesAsync();
            return item;
        }

        public async Task<MenuItem?> UpdateMenuItem(MenuItem item)
        {
            var existingItem = await _context.MenuItems.FindAsync(item.Id);
            if (existingItem == null)
                return null;

            existingItem.Name = item.Name;
            existingItem.Category = item.Category;
            existingItem.Description = item.Description;
            existingItem.Price = item.Price;
            existingItem.ImageName = item.ImageName;
            existingItem.IsPopular = item.IsPopular;
            existingItem.IsNew = item.IsNew;
            existingItem.IsAvailable = item.IsAvailable;
            existingItem.Temperature = item.Temperature;
            existingItem.Volume = item.Volume;
            existingItem.Weight = item.Weight;
            existingItem.PrepTime = item.PrepTime;
            existingItem.ContainsNuts = item.ContainsNuts;
            existingItem.UpdatedAt = DateTime.UtcNow;

            await _context.SaveChangesAsync();
            return existingItem;
        }

        public async Task<bool> DeleteMenuItem(int id)
        {
            var item = await _context.MenuItems.FindAsync(id);
            if (item == null)
                return false;

            _context.MenuItems.Remove(item);
            await _context.SaveChangesAsync();
            return true;
        }

        // ========== ИНИЦИАЛИЗАЦИЯ БАЗЫ ДАННЫХ ==========
        public async Task InitializeDatabase()
        {
            // Создаем базу данных, если её нет
            await _context.Database.EnsureCreatedAsync();

            // Заполняем меню, если оно пустое
            if (!await _context.MenuItems.AnyAsync())
            {
                await SeedMenuItems();
            }

            // Создаем тестового пользователя только если нет ни одного пользователя
            if (!await _context.Users.AnyAsync())
            {
                await SeedTestUser();
            }

            // Создаем администратора
            await SeedAdminUser();
        }

        private async Task SeedMenuItems()
        {
            var menuItems = new List<MenuItem>
            {
                // Кофе
                new MenuItem {
                    Name = "Классический эспрессо",
                    Category = "coffee",
                    Description = "Насыщенный и ароматный с плотной золотистой пенкой",
                    Price = 220,
                    ImageName = "Классический эспрессо",
                    IsPopular = true,
                    Temperature = "90°C",
                    Volume = "30 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Капучино",
                    Category = "coffee",
                    Description = "Идеальный баланс эспрессо, молока и воздушной пенки",
                    Price = 280,
                    ImageName = "Капучино",
                    IsPopular = true,
                    Temperature = "80°C",
                    Volume = "180 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Матча латте",
                    Category = "coffee",
                    Description = "Традиционный японский чай с молоком",
                    Price = 350,
                    ImageName = "Матча латте",
                    IsNew = true,
                    Temperature = "75°C",
                    Volume = "250 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Раф кофе",
                    Category = "coffee",
                    Description = "Нежный и сливочный с ванильным сиропом",
                    Price = 320,
                    ImageName = "Раф кофе",
                    IsPopular = true,
                    Temperature = "70°C",
                    Volume = "200 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Ночное признание",
                    Category = "coffee",
                    Description = "Эспрессо с темным шоколадом",
                    Price = 320,
                    ImageName = "Ночное признание",
                    IsPopular = true,
                    Temperature = "85°C",
                    Volume = "180 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Шёпот на рассвете",
                    Category = "coffee",
                    Description = "Латте с ванилью и кокосовым молоком",
                    Price = 350,
                    ImageName = "Шёпот на рассвете",
                    IsNew = true,
                    Temperature = "75°C",
                    Volume = "250 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Бархатное прикосновение",
                    Category = "coffee",
                    Description = "Капучино с карамельным сиропом",
                    Price = 340,
                    ImageName = "Бархатное прикосновение",
                    Temperature = "80°C",
                    Volume = "220 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Тайное свидание",
                    Category = "coffee",
                    Description = "Раф с апельсиновым биттером",
                    Price = 360,
                    ImageName = "Тайное свидание",
                    IsPopular = true,
                    Temperature = "70°C",
                    Volume = "200 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Объятия до утра",
                    Category = "coffee",
                    Description = "Флэт уайт с корицей и мускатом",
                    Price = 330,
                    ImageName = "Объятия до утра",
                    Temperature = "75°C",
                    Volume = "210 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Элегия страсти",
                    Category = "coffee",
                    Description = "Мокко с перцем чили",
                    Price = 370,
                    ImageName = "Элегия страсти",
                    IsNew = true,
                    Temperature = "85°C",
                    Volume = "190 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Гранатовый поцелуй",
                    Category = "coffee",
                    Description = "Американо с гранатовым сиропом",
                    Price = 310,
                    ImageName = "Гранатовый поцелуй",
                    Temperature = "90°C",
                    Volume = "180 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Шёлковое обещание",
                    Category = "coffee",
                    Description = "Кофе по-турецки с кардамоном",
                    Price = 290,
                    ImageName = "Шёлковое обещание",
                    IsPopular = true,
                    Temperature = "95°C",
                    Volume = "150 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Лунный романс",
                    Category = "coffee",
                    Description = "Айс-кофе с лавандовым сиропом",
                    Price = 380,
                    ImageName = "Лунный романс",
                    Temperature = "4°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                
                // Чай
                new MenuItem {
                    Name = "Лепестки страсти",
                    Category = "tea",
                    Description = "Красный чай с гибискусом",
                    Price = 280,
                    ImageName = "Лепестки страсти",
                    IsPopular = true,
                    Temperature = "85°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Бархатная ночь",
                    Category = "tea",
                    Description = "Черный чай с вишней",
                    Price = 290,
                    ImageName = "Бархатная ночь",
                    IsNew = true,
                    Temperature = "90°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Тайна полуночи",
                    Category = "tea",
                    Description = "Травяной сбор с мятой и лавандой",
                    Price = 270,
                    ImageName = "Тайна полуночи",
                    Temperature = "80°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Шёпот в сумерках",
                    Category = "tea",
                    Description = "Улун с персиком",
                    Price = 300,
                    ImageName = "Шёпот в сумерках",
                    IsPopular = true,
                    Temperature = "85°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Лунный сад",
                    Category = "tea",
                    Description = "Белый чай с пионом",
                    Price = 320,
                    ImageName = "Лунный сад",
                    Temperature = "75°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Медовое обещание",
                    Category = "tea",
                    Description = "Ройбуш с медом и ванилью",
                    Price = 310,
                    ImageName = "Медовое обещание",
                    IsNew = true,
                    Temperature = "85°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Эхо желания",
                    Category = "tea",
                    Description = "Пуэр с лепестками роз",
                    Price = 340,
                    ImageName = "Эхо желания",
                    Temperature = "95°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Шёлковый шёпот",
                    Category = "tea",
                    Description = "Зеленый чай с жасмином и личи",
                    Price = 290,
                    ImageName = "Шёлковый шёпот",
                    IsPopular = true,
                    Temperature = "80°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Объятия заката",
                    Category = "tea",
                    Description = "Фруктовый чай с манго",
                    Price = 280,
                    ImageName = "Объятия заката",
                    Temperature = "85°C",
                    Volume = "300 мл",
                    IsAvailable = true
                },
                
                // Десерты
                new MenuItem {
                    Name = "Красный бархат страсти",
                    Category = "dessert",
                    Description = "Торт ред вельвет с крем-чиз",
                    Price = 420,
                    ImageName = "Красный бархат страсти",
                    IsPopular = true,
                    Weight = "180 г",
                    PrepTime = 15,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Шоколадное искушение",
                    Category = "dessert",
                    Description = "Ганаш с трюфельной начинкой",
                    Price = 380,
                    ImageName = "Шоколадное искушение",
                    IsNew = true,
                    Weight = "120 г",
                    PrepTime = 10,
                    ContainsNuts = true,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Полночное танго",
                    Category = "dessert",
                    Description = "Темный шоколадный мусс с вишневым соусом",
                    Price = 390,
                    ImageName = "Полночное танго",
                    IsPopular = true,
                    Weight = "150 г",
                    PrepTime = 12,
                    ContainsNuts = false,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Французский поцелуй",
                    Category = "dessert",
                    Description = "Макарон с розовым ликером",
                    Price = 280,
                    ImageName = "Французский поцелуй",
                    Weight = "90 г",
                    PrepTime = 3,
                    ContainsNuts = false,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Обнажённая душа",
                    Category = "dessert",
                    Description = "Накед торт с ягодным конфи",
                    Price = 390,
                    ImageName = "Обнажённая душа",
                    IsNew = true,
                    Weight = "200 г",
                    PrepTime = 12,
                    ContainsNuts = false,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Опьяняющая нежность",
                    Category = "dessert",
                    Description = "Тирамису с амаретто",
                    Price = 350,
                    ImageName = "Опьяняющая нежность",
                    IsPopular = true,
                    Weight = "150 г",
                    PrepTime = 8,
                    ContainsNuts = false,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Шепот страсти",
                    Category = "dessert",
                    Description = "Павлова с маракуйей",
                    Price = 310,
                    ImageName = "Шепот страсти",
                    Weight = "160 г",
                    PrepTime = 10,
                    ContainsNuts = false,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Бархатные грезы",
                    Category = "dessert",
                    Description = "Чизкейк с карамелью",
                    Price = 370,
                    ImageName = "Бархатные грезы",
                    Weight = "170 г",
                    PrepTime = 15,
                    ContainsNuts = true,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Запретный плод",
                    Category = "dessert",
                    Description = "Яблочный тарт татен",
                    Price = 330,
                    ImageName = "Запретный плод",
                    Weight = "140 г",
                    PrepTime = 10,
                    ContainsNuts = false,
                    IsAvailable = true
                },
                new MenuItem {
                    Name = "Нью-Йорк",
                    Category = "dessert",
                    Description = "Классический чизкейк с ягодным соусом",
                    Price = 380,
                    ImageName = "Нью-Йорк",
                    IsPopular = true,
                    Weight = "170 г",
                    PrepTime = 10,
                    IsAvailable = true
                }
            };

            _context.MenuItems.AddRange(menuItems);
            await _context.SaveChangesAsync();
        }

        private async Task SeedTestUser()
        {
            var testUser = new User
            {
                Name = "Иван Томилов",
                Email = "ivan@roast.ru",
                Phone = "+7 (999) 123-45-67",
                PasswordHash = HashPassword("password123"),
                CreatedAt = DateTime.UtcNow,
                IsActive = true
            };

            _context.Users.Add(testUser);
            await _context.SaveChangesAsync();
        }

        private async Task SeedAdminUser()
        {
            // Проверяем, есть ли роль Admin
            var adminRole = await _context.Roles.FirstOrDefaultAsync(r => r.Name == "Admin");
            if (adminRole == null)
            {
                adminRole = new Role { Name = "Admin" };
                _context.Roles.Add(adminRole);
                await _context.SaveChangesAsync();
            }

            var adminUser = await _context.Users.FirstOrDefaultAsync(u => u.Email == "admin@roast.ru");
            if (adminUser == null)
            {
                adminUser = new User
                {
                    Name = "Администратор",
                    Email = "admin@roast.ru",
                    Phone = "+7 (999) 999-99-99",
                    PasswordHash = HashPassword("admin123"),
                    CreatedAt = DateTime.UtcNow,
                    IsActive = true
                };
                _context.Users.Add(adminUser);
                await _context.SaveChangesAsync();
            }

            // Назначаем роль администратора
            var userRole = await _context.UserRoles
                .FirstOrDefaultAsync(ur => ur.UserId == adminUser.Id && ur.RoleId == adminRole.Id);

            if (userRole == null)
            {
                userRole = new UserRole
                {
                    UserId = adminUser.Id,
                    RoleId = adminRole.Id
                };
                _context.UserRoles.Add(userRole);
                await _context.SaveChangesAsync();
            }
        }

        public string HashPassword(string password) 
        {
            using var sha256 = SHA256.Create();
            var hashedBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
            return Convert.ToBase64String(hashedBytes);
        }

        public bool VerifyPassword(string password, string hash)
        {
            var hashedPassword = HashPassword(password);
            return hashedPassword == hash;
        }

        private async Task<string> GenerateOrderNumber()
        {
            var date = DateTime.Now.ToString("yyyyMMdd");
            var random = new Random();
            var letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";

            string orderNumber;
            bool exists;

            do
            {
                var letterPart = new string(Enumerable.Repeat(letters, 2)
                    .Select(s => s[random.Next(s.Length)]).ToArray());
                var numberPart = random.Next(1000, 9999).ToString();
                orderNumber = $"R&R-{date}-{letterPart}{numberPart}";

                exists = await _context.Orders.AnyAsync(o => o.OrderNumber == orderNumber);
            } while (exists);

            return orderNumber;
        }

        private string NormalizePhone(string phone)
        {
            return phone.Replace(" ", "").Replace("-", "").Replace("(", "").Replace(")", "");
        }
    }
} using Roast___Rest.Models;
using Roast___Rest.Models.Database;
using DbOrder = Roast___Rest.Models.Database.Order;

namespace Roast___Rest.Services
{
    public interface IDatabaseService
    {
        // ========== ПОЛЬЗОВАТЕЛИ ==========
        Task<User?> GetUserByEmail(string email);
        Task<User?> GetUserByPhone(string phone);
        Task<User?> GetUserById(int id);
        Task<User> CreateUser(string name, string email, string phone, string password);
        Task<User?> UpdateUser(User user);
        bool VerifyPassword(string password, string hash);
        string HashPassword(string password); // ЭТОТ МЕТОД УЖЕ ЕСТЬ

        // ========== НОВЫЙ МЕТОД АУТЕНТИФИКАЦИИ ==========
        Task<User?> AuthenticateUser(string loginIdentifier, string password, string loginType);

        // ========== РОЛИ ==========
        Task<List<string>> GetUserRoles(int userId);
        Task<bool> IsUserInRole(int userId, string roleName);
        Task AddUserToRole(int userId, string roleName);
        Task RemoveUserFromRole(int userId, string roleName);

        // ========== ЗАКАЗЫ ==========
        Task<DbOrder> CreateOrder(DbOrder order);
        Task<DbOrder?> GetOrderById(int id);
        Task<DbOrder?> GetOrderByNumber(string orderNumber);
        Task<List<DbOrder>> GetUserOrders(int userId);
        Task<List<DbOrder>> GetGuestOrders(string guestToken);
        Task<DbOrder?> UpdateOrderStatus(int orderId, OrderStatus status);

        // ========== МЕНЮ ==========
        Task<List<MenuItem>> GetMenuItems(string? category = null);
        Task<MenuItem?> GetMenuItemById(int id);
        Task<MenuItem?> GetMenuItemByName(string name);
        Task<MenuItem> CreateMenuItem(MenuItem item);
        Task<MenuItem?> UpdateMenuItem(MenuItem item);
        Task<bool> DeleteMenuItem(int id);

        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        Task InitializeDatabase();
    }
} using SixLabors.ImageSharp;
using SixLabors.ImageSharp.Formats.Png;
using SixLabors.ImageSharp.Processing;
using System.Text;
using System.Text.RegularExpressions;

namespace Roast___Rest.Services
{
    public interface IImageService
    {
        Task<ImageSaveResult> SaveAndOptimizeImage(IFormFile file, string itemName, string category, string webRootPath);
        Task<bool> DeleteImage(string imageName, string category, string webRootPath);
        string GetCategoryFolder(string category);
    }

    public class ImageService : IImageService
    {
        private readonly ILogger<ImageService> _logger;
        private readonly string[] _allowedExtensions = { ".png", ".jpg", ".jpeg", ".gif", ".bmp", ".webp" };
        private readonly long _maxFileSize = 5 * 1024 * 1024; // 5MB
        private readonly int _maxDimension = 800;

        public ImageService(ILogger<ImageService> logger)
        {
            _logger = logger;
        }

        public async Task<ImageSaveResult> SaveAndOptimizeImage(IFormFile file, string itemName, string category, string webRootPath)
        {
            var result = new ImageSaveResult();

            try
            {
                // Проверка расширения
                var extension = Path.GetExtension(file.FileName).ToLowerInvariant();
                if (!_allowedExtensions.Contains(extension))
                {
                    result.ErrorMessage = $"Разрешены только форматы: {string.Join(", ", _allowedExtensions)}";
                    return result;
                }

                // Проверка размера
                if (file.Length > _maxFileSize)
                {
                    result.ErrorMessage = $"Файл слишком большой. Максимальный размер {_maxFileSize / 1024 / 1024}MB";
                    return result;
                }

                // Генерируем имя файла
                string fileName = GenerateFileName(itemName);
                string categoryFolder = GetCategoryFolder(category);
                string uploadPath = Path.Combine(webRootPath, "images", "menu", categoryFolder);

                // Создаем папку, если её нет
                if (!Directory.Exists(uploadPath))
                {
                    Directory.CreateDirectory(uploadPath);
                }

                string filePath = Path.Combine(uploadPath, fileName + ".png");

                // Оптимизация изображения
                using (var stream = file.OpenReadStream())
                using (var image = await Image.LoadAsync(stream))
                {
                    // Автоматическая ориентация
                    image.Mutate(x => x.AutoOrient());

                    // Изменяем размер при необходимости
                    if (image.Width > _maxDimension || image.Height > _maxDimension)
                    {
                        var resizeOptions = new ResizeOptions
                        {
                            Size = new Size(_maxDimension, _maxDimension),
                            Mode = ResizeMode.Max,
                            Position = AnchorPositionMode.Center
                        };
                        image.Mutate(x => x.Resize(resizeOptions));
                    }

                    // Обрезаем до квадрата при необходимости
                    if (Math.Abs(image.Width - image.Height) > 10)
                    {
                        var size = Math.Min(image.Width, image.Height);
                        var resizeOptions = new ResizeOptions
                        {
                            Size = new Size(size, size),
                            Mode = ResizeMode.Crop,
                            Position = AnchorPositionMode.Center
                        };
                        image.Mutate(x => x.Resize(resizeOptions));
                    }

                    // Сохраняем с оптимальным сжатием
                    var encoder = new PngEncoder
                    {
                        CompressionLevel = PngCompressionLevel.BestCompression,
                        ColorType = PngColorType.RgbWithAlpha,
                        TransparentColorMode = PngTransparentColorMode.Preserve
                    };

                    await image.SaveAsync(filePath, encoder);
                }

                result.Success = true;
                result.FileName = fileName;
                return result;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Ошибка при обработке изображения {FileName}", file.FileName);
                result.ErrorMessage = "Ошибка при обработке изображения. Убедитесь, что файл не поврежден.";
                return result;
            }
        }

        public async Task<bool> DeleteImage(string imageName, string category, string webRootPath)
        {
            if (string.IsNullOrEmpty(imageName))
                return false;

            try
            {
                string categoryFolder = GetCategoryFolder(category);
                string[] extensions = { ".png", ".jpg", ".jpeg", ".gif", ".bmp", ".webp" };

                foreach (var ext in extensions)
                {
                    string imagePath = Path.Combine(webRootPath, "images", "menu", categoryFolder, imageName + ext);
                    if (File.Exists(imagePath))
                    {
                        File.Delete(imagePath);
                        _logger.LogInformation("Удален файл: {ImagePath}", imagePath);
                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Ошибка при удалении файла изображения {ImageName}", imageName);
            }

            return false;
        }

        public string GetCategoryFolder(string category)
        {
            return category.ToLower() switch
            {
                "coffee" => "кофе",
                "tea" => "чай",
                "dessert" => "десерты",
                _ => category.ToLower()
            };
        }

        private string GenerateFileName(string itemName)
        {
            // Транслитерация
            string fileName = Transliterate(itemName);

            // Удаляем недопустимые символы
            fileName = Regex.Replace(fileName, @"[^a-zA-Z0-9\s-]", "");
            fileName = Regex.Replace(fileName, @"\s+", "-");
            fileName = Regex.Replace(fileName, @"-+", "-");

            // Обрезаем до разумной длины
            if (fileName.Length > 50)
            {
                fileName = fileName.Substring(0, 50);
            }

            // Добавляем уникальный суффикс
            fileName = fileName.Trim('-') + "_" + DateTime.Now.Ticks;

            return string.IsNullOrEmpty(fileName) ? "image_" + DateTime.Now.Ticks : fileName;
        }

        private string Transliterate(string text)
        {
            var rus = new Dictionary<char, string>
            {
                {'а', "a"}, {'б', "b"}, {'в', "v"}, {'г', "g"}, {'д', "d"},
                {'е', "e"}, {'ё', "e"}, {'ж', "zh"}, {'з', "z"}, {'и', "i"},
                {'й', "y"}, {'к', "k"}, {'л', "l"}, {'м', "m"}, {'н', "n"},
                {'о', "o"}, {'п', "p"}, {'р', "r"}, {'с', "s"}, {'т', "t"},
                {'у', "u"}, {'ф', "f"}, {'х', "kh"}, {'ц', "ts"}, {'ч', "ch"},
                {'ш', "sh"}, {'щ', "shch"}, {'ъ', ""}, {'ы', "y"}, {'ь', ""},
                {'э', "e"}, {'ю', "yu"}, {'я', "ya"},
                {'А', "A"}, {'Б', "B"}, {'В', "V"}, {'Г', "G"}, {'Д', "D"},
                {'Е', "E"}, {'Ё', "E"}, {'Ж', "Zh"}, {'З', "Z"}, {'И', "I"},
                {'Й', "Y"}, {'К', "K"}, {'Л', "L"}, {'М', "M"}, {'Н', "N"},
                {'О', "O"}, {'П', "P"}, {'Р', "R"}, {'С', "S"}, {'Т', "T"},
                {'У', "U"}, {'Ф', "F"}, {'Х', "Kh"}, {'Ц', "Ts"}, {'Ч', "Ch"},
                {'Ш', "Sh"}, {'Щ', "Shch"}, {'Ъ', ""}, {'Ы', "Y"}, {'Ь', ""},
                {'Э', "E"}, {'Ю', "Yu"}, {'Я', "Ya"}
            };

            var result = new StringBuilder();
            foreach (var ch in text)
            {
                if (rus.ContainsKey(ch))
                    result.Append(rus[ch]);
                else if (char.IsLetterOrDigit(ch) || ch == '-' || ch == '_')
                    result.Append(ch);
                else
                    result.Append('-');
            }

            return result.ToString();
        }
    }

    public class ImageSaveResult
    {
        public bool Success { get; set; }
        public string FileName { get; set; } = string.Empty;
        public string ErrorMessage { get; set; } = string.Empty;
    }
} using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Roast___Rest.Models.Database
{
    public class MenuItem
    {
        [Key]
        public int Id { get; set; }

        [Required, MaxLength(200)]
        public string Name { get; set; } = string.Empty;

        [Required, MaxLength(50)]
        public string Category { get; set; } = string.Empty; // coffee, tea, dessert

        [MaxLength(500)]
        public string? Description { get; set; }

        [Column(TypeName = "decimal(18,2)")]
        public decimal Price { get; set; }

        [MaxLength(255)]
        public string? ImageName { get; set; }

        public bool IsPopular { get; set; }
        public bool IsNew { get; set; }
        public bool IsAvailable { get; set; } = true;

        // Специфичные поля
        [MaxLength(20)]
        public string? Temperature { get; set; }

        [MaxLength(20)]
        public string? Volume { get; set; }

        [MaxLength(20)]
        public string? Weight { get; set; }

        public int? PrepTime { get; set; }
        public bool ContainsNuts { get; set; }

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime? UpdatedAt { get; set; }
    }
} using Microsoft.AspNetCore.Http;
using Newtonsoft.Json;
using Roast___Rest.Models;
using Roast___Rest.Services;
using Roast___Rest.Models.Database;
using SessionOrder = Roast___Rest.Models.Order;

namespace Roast___Rest.Extensions
{
    public static class SessionExtensions
    {
        public static void SetObject<T>(this ISession session, string key, T value)
        {
            session.SetString(key, JsonConvert.SerializeObject(value));
        }

        public static T? GetObject<T>(this ISession session, string key)
        {
            var value = session.GetString(key);
            return value == null ? default : JsonConvert.DeserializeObject<T>(value);
        }

        // Методы для работы с корзиной
        public static Cart GetCart(this ISession session)
        {
            var cart = session.GetObject<Cart>("Cart");
            if (cart == null)
            {
                cart = new Cart();
                session.SetObject("Cart", cart);
            }
            return cart;
        }

        public static void UpdateCart(this ISession session, Cart cart)
        {
            session.SetObject("Cart", cart);
        }

        public static void ClearCart(this ISession session)
        {
            session.Remove("Cart");
        }

        // Методы для работы с пользователем
        public static UserSession? GetUser(this ISession session)
        {
            return session.GetObject<UserSession>("User");
        }

        public static void SetUser(this ISession session, UserSession user)
        {
            session.SetObject("User", user);
        }

        public static void ClearUser(this ISession session)
        {
            session.Remove("User");
        }

        public static bool IsAuthenticated(this ISession session)
        {
            var user = session.GetUser();
            return user?.IsAuthenticated ?? false;
        }

        public static async Task<UserSession?> AuthenticateUserAsync(this ISession session,
    string loginIdentifier, string password, string loginType, IDatabaseService dbService)
        {
            User? user = null;

            if (loginType == "email")
            {
                user = await dbService.GetUserByEmail(loginIdentifier);
            }
            else if (loginType == "phone")
            {
                user = await dbService.GetUserByPhone(loginIdentifier);
            }

            if (user != null && dbService.VerifyPassword(password, user.PasswordHash))
            {
                // Обновляем время последнего входа
                user.LastLoginAt = DateTime.UtcNow;
                await dbService.UpdateUser(user);

                // ПОЛУЧАЕМ РОЛИ ПОЛЬЗОВАТЕЛЯ
                var roles = await dbService.GetUserRoles(user.Id);

                var userSession = new UserSession
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Phone = user.Phone,
                    IsAuthenticated = true,
                    LastLogin = user.LastLoginAt.Value,
                    Roles = roles 
                };

                session.SetUser(userSession);
                return userSession;
            }

            return null;
        }

        // Методы для работы с заказами
        public static void AddOrder(this ISession session, SessionOrder order)
        {
            var orders = session.GetObject<List<SessionOrder>>("Orders") ?? new List<SessionOrder>();
            orders.Add(order);
            session.SetObject("Orders", orders);
        }

        public static List<SessionOrder> GetUserOrders(this ISession session, int? userId = null, string? guestToken = null)
        {
            var orders = session.GetObject<List<SessionOrder>>("Orders") ?? new List<SessionOrder>();

            if (userId.HasValue)
            {
                return orders.Where(o => o.UserId == userId).ToList();
            }
            else if (!string.IsNullOrEmpty(guestToken))
            {
                return orders.Where(o => o.GuestToken == guestToken).ToList();
            }

            return new List<SessionOrder>();
        }
    }
} using Microsoft.EntityFrameworkCore;
using Roast___Rest.Models.Database;

namespace Roast___Rest.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options)
            : base(options)
        {
        }

        public DbSet<User> Users { get; set; }
        public DbSet<Models.Database.Order> Orders { get; set; }
        public DbSet<OrderItem> OrderItems { get; set; }
        public DbSet<MenuItem> MenuItems { get; set; }

        // Добавляем новые таблицы для ролей
        public DbSet<Role> Roles { get; set; }
        public DbSet<UserRole> UserRoles { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Уникальные индексы
            modelBuilder.Entity<User>()
                .HasIndex(u => u.Email)
                .IsUnique();

            modelBuilder.Entity<User>()
                .HasIndex(u => u.Phone)
                .IsUnique();

            modelBuilder.Entity<Models.Database.Order>()
                .HasIndex(o => o.OrderNumber)
                .IsUnique();

            // Индексы для поиска
            modelBuilder.Entity<Models.Database.Order>()
                .HasIndex(o => o.UserId);

            modelBuilder.Entity<Models.Database.Order>()
                .HasIndex(o => o.GuestToken);

            modelBuilder.Entity<Models.Database.Order>()
                .HasIndex(o => o.Status);

            modelBuilder.Entity<OrderItem>()
                .HasIndex(o => o.OrderId);

            modelBuilder.Entity<MenuItem>()
                .HasIndex(m => m.Category);

            // Индексы для ролей
            modelBuilder.Entity<Role>()
                .HasIndex(r => r.Name)
                .IsUnique();

            modelBuilder.Entity<UserRole>()
                .HasIndex(ur => new { ur.UserId, ur.RoleId })
                .IsUnique();
        }
    }
} using Roast___Rest.Services;
using Microsoft.Extensions.DependencyInjection;

namespace Roast___Rest.Data
{
    public static class SeedData
    {
        public static async Task Initialize(IServiceProvider serviceProvider)
        {
            using var scope = serviceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            var service = new DatabaseService(context);
            await service.InitializeDatabase();
        }
    }
} 
 